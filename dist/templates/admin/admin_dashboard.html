{% extends 'base.html' %}
{% block title %}Admin Dashboard â€” HR Logbook{% endblock %}

{% block head_extra %}
<style>
  .card {
    margin-bottom: 1rem
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-2">
  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0"><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h5>
      <div class="d-flex gap-2">
        <a class="btn btn-sm btn-outline-success d-flex align-items-center" href="/admin/backup/download">
          <i class="fas fa-download me-2"></i>
          <span class="d-none d-md-inline">Backup Data</span>
        </a>

        <form action="/admin/backup/restore" method="POST" enctype="multipart/form-data" id="restoreForm">
          <input type="file" name="backup_file" id="backupFile" style="display: none;" accept=".zip"
            onchange="confirmRestore()">
          <button type="button" class="btn btn-sm btn-outline-warning d-flex align-items-center"
            onclick="document.getElementById('backupFile').click()">
            <i class="fas fa-upload me-2"></i>
            <span class="d-none d-md-inline">Restore Data</span>
          </button>
        </form>

        <script>
          function confirmRestore() {
            if (confirm('WARNING: Restoring will REPLACE all current data with the backup data. This cannot be undone. Are you sure?')) {
              document.getElementById('restoreForm').submit();
            } else {
              document.getElementById('backupFile').value = ''; // clear selection
            }
          }
        </script>
      </div>
    </div>

    <div class="card-body">
      <div class="row">
        <div class="col-md-3">
          <a href="{{ url_for('client.client_data') }}" class="text-decoration-none">
            <div class="card shadow-sm p-3">
              <h6><i class="fas fa-users"></i> Total Registered Clients</h6>
              <h2>{{ stats.total_clients }}</h2>
            </div>
          </a>
        </div>
        <div class="col-md-3">
          <a href="{{ url_for('client.client_log_report') }}" class="text-decoration-none">
            <div class="card shadow-sm p-3">
              <h6><i class="fas fa-clipboard-list"></i> Total Logs</h6>
              <h2>{{ stats.total_logs }}</h2>
            </div>
          </a>
        </div>
        <div class="col-md-6">
          <a href="{{ url_for('client.client_log_report') }}" class="text-decoration-none">
            <div class="card shadow-sm p-3">
              <h6><i class="fas fa-chart-line"></i> Recent Activity (last 14 days)</h6>
              <canvas id="chartActivity" height="80"></canvas>
            </div>
          </a>
        </div>
      </div>

      <div class="row mt-3">
        <div class="col-md-12">
          <a href="{{ url_for('client.client_log_report') }}" class="text-decoration-none">
            <div class="card shadow-sm p-3">
              <h6><i class="fas fa-chart-bar"></i> Purpose Counts</h6>
              <div style="min-height: 300px; position: relative;">
                <canvas id="chartPurpose"></canvas>
              </div>
            </div>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Load Chart.js offline -->
<script src="{{ url_for('static', filename='js/chart.js') }}"></script>

<script>
  async function loadChartData(days = 14) {
    const res = await fetch('/admin/chart_data?days=' + days);
    const data = await res.json();
    return data;
  }

  function buildLineChart(ctx, labels, data) {
    return new Chart(ctx, {
      type: 'line',
      data: { labels, datasets: [{ label: 'Entries', data, fill: false, borderColor: '#0d6efd', tension: 0.2 }] },
      options: { responsive: true }
    });
  }



  function buildBarChart(ctx, labels, data) {
    // Elegant colors for purposes
    const colors = [
      '#0d6efd', '#198754', '#ffc107', '#dc3545', '#0dcaf0',
      '#6610f2', '#fd7e14', '#20c997', '#e83e8c', '#6f42c1'
    ];

    // Expand colors if there are more labels than colors
    const backgroundColors = labels.map((_, i) => colors[i % colors.length]);

    return new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Times Requested',
          data,
          backgroundColor: backgroundColors,
          borderRadius: 4,
          borderSkipped: false
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function (context) {
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const value = context.parsed.x;
                const percentage = ((value / total) * 100).toFixed(1);
                return ` Count: ${value} (${percentage}%)`;
              }
            }
          }
        },
        scales: {
          x: {
            beginAtZero: true,
            grid: { display: false },
            ticks: { precision: 0 }
          },
          y: {
            grid: { display: false }
          }
        }
      }
    });
  }

  // Wait for Chart.js to load before building charts
  function waitForChartJS(callback) {
    if (typeof Chart !== 'undefined') {
      callback();
    } else {
      setTimeout(() => waitForChartJS(callback), 100);
    }
  }

  waitForChartJS(async () => {
    const d = await loadChartData(14);
    // by_day -> list of {day, cnt}
    const days = d.by_day.map(r => r.day);
    const dayCounts = d.by_day.map(r => r.cnt);
    const ctxA = document.getElementById('chartActivity').getContext('2d');
    buildLineChart(ctxA, days, dayCounts);



    const pLabels = d.purpose.map(r => r.purpose);
    const pCounts = d.purpose.map(r => r.cnt);
    const ctxP = document.getElementById('chartPurpose').getContext('2d');
    buildBarChart(ctxP, pLabels, pCounts);
  });
</script>
{% endblock %}