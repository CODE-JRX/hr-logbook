{% extends 'base.html' %}
{% block title %}Admin Signup â€” HR Logbook{% endblock %}

{% block head_extra %}
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<style>
  .media-frame {
    width: 100%;
    aspect-ratio: 4 / 3;
    /* modern browsers */
    max-height: 420px;
    background: #0f1720;
    border-radius: 8px;
    border: 3px solid rgba(13, 110, 253, 0.08);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
  }

  .media-frame video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  /* Make preview match live preview â€” use cover so framing matches */
  .media-frame img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  /* Camera guide: subtle broken square shown over the live preview */
  #face-guide {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 60%;
    height: 60%;
    pointer-events: none;
    z-index: 6;
  }

  #face-guide .fg-corner {
    position: absolute;
    width: clamp(32px, 8%, 56px);
    height: clamp(32px, 8%, 56px);
    box-sizing: border-box;
    border-radius: 4px;
    border-color: rgba(154,166,188,0.28);
    border-style: solid;
  }

  #face-guide .top-left { top: 0; left: 0; border-right: none; border-bottom: none; }
  #face-guide .top-right { top: 0; right: 0; border-left: none; border-bottom: none; }
  #face-guide .bottom-right { bottom: 0; right: 0; border-left: none; border-top: none; }
  #face-guide .bottom-left { bottom: 0; left: 0; border-right: none; border-top: none; }

  #previewBox {
    padding: .5rem;
    background: #f8fafc;
  }

  .message-overlay {
    position: absolute;
    top: 10px;
    left: 10px;
    right: 10px;
    padding: 6px 10px;
    border-radius: 6px;
    color: white;
    font-weight: bold;
    text-align: center;
    z-index: 10;
    display: none;
    font-size: 12px;
    line-height: 1.2;
    word-wrap: break-word;
  }

  .message-overlay.success {
    background-color: rgba(25, 135, 84, 1);
  }

  .message-overlay.error {
    background-color: rgba(220, 53, 69, 1);
  }
</style>
{% endblock %}

{% block content %}
	<div class="card shadow-sm mx-auto" style="max-width:760px;">
		<div class="card-body">
			<h4 class="card-title mb-3">Create Admin Account</h4>

			{% if error %}
			<div class="alert alert-danger">{{ error }}</div>
			{% endif %}

			{% if success %}
			<div class="alert alert-success">{{ success }}</div>
			{% endif %}

			<form method="post" action="/admin/signup" novalidate id="adminSignupForm">
				<div class="row g-3">
					<div class="col-12 col-md-6">
						<label for="first_name" class="form-label">First name <span class="text-danger">*</span></label>
						<input type="text" class="form-control" id="first_name" name="first_name" required>
					</div>
					<div class="col-12 col-md-6">
						<label for="last_name" class="form-label">Last name <span class="text-danger">*</span></label>
						<input type="text" class="form-control" id="last_name" name="last_name" required>
					</div>

					<div class="col-12">
						<label for="email" class="form-label">Email <span class="text-danger">*</span></label>
						<input type="email" class="form-control" id="email" name="email" required>
					</div>

					<div class="col-12 col-md-6">
						<label for="password" class="form-label">Password <span class="text-danger">*</span></label>
						<input type="password" class="form-control" id="password" name="password" required>
					</div>

					<div class="col-12 col-md-6">
						<label for="confirm_password" class="form-label">Confirm Password <span class="text-danger">*</span></label>
						<input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
					</div>

					<div class="col-12">
						<label class="form-label">Photo <span class="text-danger">*</span></label>
						<div class="row g-2">
							<div class="col-md-6">
								<div class="mx-auto shadow-sm rounded media-frame">
									<video id="video" autoplay playsinline style="display:none; border-radius:6px;"></video>

									<!-- face position guide (subtle broken square corners) -->
									<div id="face-guide" aria-hidden="true">
										<div class="fg-corner top-left"></div>
										<div class="fg-corner top-right"></div>
										<div class="fg-corner bottom-right"></div>
										<div class="fg-corner bottom-left"></div>
									</div>
									<div id="camera-placeholder" class="text-center text-muted" style="color:#9aa6bc">
										<div style="font-size:38px; opacity:0.6">ðŸ“·</div>
										<div style="margin-top:6px;">Camera Preview</div>
									</div>
									<canvas id="canvas" width="420" height="320" style="display:none; position:absolute; top:0; left:0; border-radius:6px;"></canvas>
								</div>

								<div class="mt-3 text-center">
									<button id="camera-action" type="button" class="btn btn-primary me-2"><i class="fas fa-play"></i> Start Camera</button>
									<button id="file-toggle" type="button" class="btn btn-outline-secondary"><i class="fas fa-upload"></i> Use file</button>
								</div>
							</div>

							<div class="col-md-6">
								<div class="mb-2">
									<div class="border rounded p-0 media-frame" id="previewBox">
										<div style="text-align:center; width:100%;"> <span class="text-muted">No image captured | Preview</span></div>
										<div id="message-overlay" class="message-overlay"></div>
									</div>
								</div>

								<div id="fileArea" style="display:none;">
									<label for="fileInput" class="form-label">Upload image</label>
									<input id="fileInput" class="form-control" type="file" accept="image/*">
									<div class="form-text">If camera is unavailable, upload a photo (JPEG/PNG). Max 5MB.</div>
								</div>

								<div class="mt-3">
									<button id="signupBtn" type="submit" class="btn btn-success" disabled><i class="fas fa-user-plus"></i> Create account</button>
									<a href="/admin/login" class="btn btn-outline-secondary ms-2"><i class="fas fa-sign-in-alt"></i> Sign in</a>
								</div>
							</div>
						</div>
					</div>
				</div>
				<input type="hidden" name="photo_data" id="photo_data">
			</form>

			<hr>
			<p class="small mb-0">Already have an account? <a href="/admin/login">Sign in</a></p>
		</div>
	</div>
{% endblock %}

{% block scripts %}
<script>
	const video = document.getElementById('video');
	const canvas = document.getElementById('canvas');
	const preview = document.getElementById('preview');
	const placeholder = document.getElementById('camera-placeholder');
	const actionBtn = document.getElementById('camera-action');
	const photoInput = document.getElementById('photo_data');
	const previewBox = document.getElementById('previewBox');
	const fileToggle = document.getElementById('file-toggle');
	const fileArea = document.getElementById('fileArea');
	const fileInput = document.getElementById('fileInput');
	const signupBtn = document.getElementById('signupBtn');
	const messageOverlay = document.getElementById('message-overlay');
	let stream = null;
	let cameraState = 'stopped'; // 'stopped' | 'started' | 'captured'
	let faceVerified = false; // Track if face has been verified
	let messageTimeout = null; // To manage message timeout

	// Function to show message overlay
	function showMessage(message, type) {
		console.log('Showing message:', message, 'type:', type);
		messageOverlay.textContent = message;
		messageOverlay.className = `message-overlay ${type}`;
		messageOverlay.style.display = 'block';
		// Clear any existing timeout
		if (messageTimeout) clearTimeout(messageTimeout);
		// Hide after 4 seconds
		messageTimeout = setTimeout(() => {
			messageOverlay.style.display = 'none';
		}, 4000);
	}

	// Function to hide message overlay
	function hideMessage() {
		messageOverlay.style.display = 'none';
		if (messageTimeout) {
			clearTimeout(messageTimeout);
			messageTimeout = null;
		}
	}

	actionBtn.addEventListener('click', async () => {
		try {
			if (cameraState === 'stopped') {
				stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } });
				video.srcObject = stream;
				video.style.display = 'block';
				placeholder.style.display = 'none';
				actionBtn.textContent = 'Capture';
				cameraState = 'started';
				return;
			}

			if (cameraState === 'started') {
				if (!stream) { alert('Start the camera first'); return; }

				const ctx = canvas.getContext('2d');
				// Calculate the visible area in video coordinates to match object-fit: cover
				const containerW = 420;
				const containerH = 320;
				const vw = video.videoWidth || 420;
				const vh = video.videoHeight || 320;
				const scale = Math.max(containerW / vw, containerH / vh);
				const scaledW = vw * scale;
				const scaledH = vh * scale;
				let sourceX = 0, sourceY = 0, sourceW = vw, sourceH = vh;
				if (scaledW > containerW) {
					// crop horizontally
					const cropAmount = (scaledW - containerW) / scale;
					sourceX = cropAmount / 2;
					sourceW = vw - cropAmount;
				} else {
					// crop vertically
					const cropAmount = (scaledH - containerH) / scale;
					sourceY = cropAmount / 2;
					sourceH = vh - cropAmount;
				}
				// Set canvas size to the cropped visible area, then scale down if needed
				let targetW = sourceW;
				let targetH = sourceH;
				const MAX_W = 800;
				if (targetW > MAX_W) {
					const scaleDown = MAX_W / targetW;
					targetW = Math.round(targetW * scaleDown);
					targetH = Math.round(targetH * scaleDown);
				}
				canvas.width = targetW;
				canvas.height = targetH;
				// Draw only the visible cropped part
				ctx.drawImage(video, sourceX, sourceY, sourceW, sourceH, 0, 0, targetW, targetH);
				const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
				// display in preview box (single canonical preview)
				const placeholder = previewBox.querySelector('div[style*="text-align:center"]');
				if (placeholder) placeholder.remove();
				const img = document.createElement('img'); img.src = dataUrl; img.style.width = '100%'; img.style.height = '100%'; img.style.objectFit = 'cover'; previewBox.appendChild(img);
				video.style.display = 'none';
				actionBtn.textContent = 'Stop Camera';
				cameraState = 'captured';
				photoInput.value = dataUrl;

				// Verify face
				const verificationResult = await verifyFace(dataUrl);
				if (verificationResult.ok) {
					faceVerified = true;
					showMessage('Face verified successfully!', 'success');
				} else {
					faceVerified = false;
					showMessage(verificationResult.message, 'error');
				}
				validateForm();
				return;
			}

			if (cameraState === 'captured') {
				if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
				video.srcObject = null;
				video.style.display = 'none';
				placeholder.style.display = 'block';
				photoInput.value = '';
				faceVerified = false; // Reset face verification
				actionBtn.textContent = 'Start Camera';
				cameraState = 'stopped';
				previewBox.innerHTML = '<div style="text-align:center; width:100%;"> <span class="text-muted">No image captured</span></div>';
				hideMessage(); // Hide any existing message
				validateForm();
				return;
			}
		} catch (err) {
			alert('Camera error: ' + err.message);
		}
	});

	// File upload fallback
	fileToggle.addEventListener('click', () => {
		if (fileArea.style.display === 'none' || fileArea.style.display === '') {
			fileArea.style.display = 'block';
			actionBtn.disabled = true;
			fileToggle.textContent = 'Use camera';
		} else {
			fileArea.style.display = 'none';
			actionBtn.disabled = false;
			fileToggle.textContent = 'Use file';
		}
	});

	fileInput && fileInput.addEventListener('change', async (e) => {
		const f = e.target.files && e.target.files[0];
		if (!f) return;
		if (f.size > 5 * 1024 * 1024) { alert('File too large (max 5MB)'); return; }
		const reader = new FileReader();
		reader.onload = async function (ev) {
			const data = ev.target.result;
			photoInput.value = data;
			const placeholder = previewBox.querySelector('div[style*="text-align:center"]');
			if (placeholder) placeholder.remove();
			const img = document.createElement('img'); img.src = data; img.style.width = '100%'; img.style.height = '100%'; img.style.objectFit = 'cover'; previewBox.appendChild(img);

			// Verify face
			const verificationResult = await verifyFace(data);
			if (verificationResult.ok) {
				faceVerified = true;
				showMessage('Face verified successfully!', 'success');
			} else {
				faceVerified = false;
				showMessage(verificationResult.message, 'error');
			}
			validateForm();
		};
		reader.readAsDataURL(f);
	});

	// Function to verify face using the server endpoint
	async function verifyFace(photoData) {
		try {
			const response = await fetch('/verify_face', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/x-www-form-urlencoded',
				},
				body: new URLSearchParams({ photo_data: photoData })
			});
			const result = await response.json();
			return result;
		} catch (error) {
			console.error('Face verification error:', error);
			return { ok: false, message: 'Error verifying face. Please try again.' };
		}
	}

	// Basic client-side validation: require first_name, last_name, email, password, confirm_password, photo, and face verification
	function validateForm() {
		const firstName = document.getElementById('first_name').value.trim();
		const lastName = document.getElementById('last_name').value.trim();
		const email = document.getElementById('email').value.trim();
		const password = document.getElementById('password').value.trim();
		const confirmPassword = document.getElementById('confirm_password').value.trim();
		const photo = document.getElementById('photo_data').value;
		const passwordsMatch = password === confirmPassword;
		signupBtn.disabled = !(firstName && lastName && email && password && confirmPassword && passwordsMatch && photo && faceVerified);
	}

	['first_name', 'last_name', 'email', 'password', 'confirm_password'].forEach(id => document.getElementById(id).addEventListener('input', validateForm));

	// on submit, disable signup button to prevent double submit
	document.getElementById('adminSignupForm').addEventListener('submit', (e) => {
		signupBtn.disabled = true;
		signupBtn.textContent = 'Creating account...';
	});
</script>
{% endblock %}
