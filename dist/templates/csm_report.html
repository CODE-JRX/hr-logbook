{% extends 'base.html' %}
{% block title %}Client Satisfactory Report â€” HR Logbook{% endblock %}

{% block head_extra %}
<style>
    /* CSM Report Page Styles - Screen View */
    /* Note: Inherits base styles from custom.css, only adds page-specific overrides */

    .csm-report-page main {
        margin-top: 0;
        padding-top: 20px;
    }

    .card {
        box-shadow: none !important;
    }

    .screen-view {
        display: block;
        padding-top: 0;
    }

    /* Hide elements when printing */
    .no-print {
        display: block;
    }

    @media print {
        .no-print {
            display: none !important;
        }
    }

    /* Filter section styling - uses card background */
    .filter-section {
        background: var(--card-bg);
        padding: 20px 20px 0 20px;
        margin-top: 0;
        margin-bottom: 0;
        border-radius: 0;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: none !important;
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
    }

    /* remove top rounding when card should have square top corners */
    .no-top-radius {
        border-top-left-radius: 0 !important;
        border-top-right-radius: 0 !important;
    }

    .no-top-radius .card-header {
        border-top-left-radius: 0 !important;
        border-top-right-radius: 0 !important;
    }

    /* Background image for filter section */
    .filter-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: url('../static/resources/project-bg.png');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        opacity: 0.15;
        z-index: 0;
        pointer-events: none;
    }

    .filter-section>* {
        position: relative;
        z-index: 1;
    }

    [data-theme="dark"] .filter-section::before {
        opacity: 0.08;
    }

    .filter-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }

    .filter-header h3 {
        margin-bottom: 0;
        color: var(--primary-color);
    }

    .filter-section::after {
        display: none;
    }

    [data-theme="dark"] .card {
        box-shadow: none !important;
    }

    [data-theme="dark"] .filter-section {
        box-shadow: none !important;
    }

    [data-theme="dark"] .results-card {
        box-shadow: none !important;
    }

    [data-theme="dark"] .btn-secondary {
        background-color: #374151;
        color: #e2e8f0;
    }

    [data-theme="dark"] .btn-secondary:hover {
        background-color: #4b5563;
    }

    .filter-form {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 15px;
    }

    .filter-row {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    .filter-group {
        flex: 1;
        min-width: 150px;
    }

    .filter-group.full-width {
        flex: 1 1 100%;
    }

    .filter-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--text-color);
    }

    .filter-group input,
    .filter-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 14px;
        background: var(--card-bg);
        color: var(--text-color);
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    .filter-group input:focus,
    .filter-group select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
    }

    .filter-form button,
    .filter-actions .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 25px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .filter-summary {
        margin-top: 15px;
        padding: 10px 15px;
        background: rgba(102, 126, 234, 0.1);
        border-radius: 8px;
        color: var(--text-color);
    }

    [data-theme="dark"] .filter-summary {
        background: rgba(124, 58, 237, 0.15);
    }

    /* Results card styling */
    .results-card {
        background: var(--card-bg);
        padding: 0 20px 20px 20px;
        border-radius: 0 0 15px 15px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-top: none;
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
    }

    /* Background image for results card */
    .results-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: url('../static/resources/project-bg.png');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        opacity: 0.1;
        z-index: 0;
        pointer-events: none;
    }

    .results-card>* {
        position: relative;
        z-index: 1;
    }

    [data-theme="dark"] .results-card::before {
        opacity: 0.05;
    }

    .table-responsive {
        overflow-x: auto;
        margin-bottom: 0;
    }

    .results-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
    }

    /* Match client_log_report header: solid primary background and white text */
    .results-table thead {
        background-color: var(--primary-color);
        color: white;
    }

    /* Header and cells: visible borders and compact padding like client_log_report */
    .results-table th,
    .results-table td {
        padding: 5px;
        border: 1px solid var(--border-color);
        text-align: center;
        font-size: 13px;
    }

    .results-table th {
        font-weight: 600;
    }

    .results-table td {
        color: var(--text-color);
    }

    .results-table tbody tr {
        transition: background-color 0.2s ease;
    }

    .results-table tbody tr:nth-child(even) {
        background-color: rgba(0, 0, 0, 0.02);
    }

    [data-theme="dark"] .results-table tbody tr:nth-child(even) {
        background-color: rgba(255, 255, 255, 0.02);
    }

    .results-table tbody tr:hover {
        background-color: rgba(102, 126, 234, 0.08);
    }

    [data-theme="dark"] .results-table tbody tr:hover {
        background-color: rgba(124, 58, 237, 0.15);
    }

    /* Print-only styles */
    .print-forms {
        display: none;
    }

    .form-page {
        page-break-after: always;
        page-break-inside: avoid;
    }

    /* Print form container styling (for print preview structure) */
    .form-page .container {
        max-width: 1000px;
        margin: 0 auto;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        padding: 30px;
        position: relative;
        border-top: 5px solid #2c5aa0;
    }

    .form-page .header {
        text-align: center;
        margin-bottom: 30px;
        border-bottom: 2px solid #eee;
        padding-bottom: 20px;
    }

    .form-page .institute-name {
        font-size: 22px;
        font-weight: bold;
        color: #2c5aa0;
        margin-bottom: 5px;
    }

    .form-page .campus {
        font-size: 16px;
        color: #555;
        margin-bottom: 20px;
    }

    .form-page .form-title {
        font-size: 24px;
        font-weight: bold;
        color: #d32f2f;
        margin-bottom: 10px;
        text-transform: uppercase;
    }

    .form-page .subtitle {
        font-size: 18px;
        color: #2c5aa0;
        font-weight: bold;
        margin-bottom: 15px;
    }

    .form-page .control-no {
        position: absolute;
        top: 5px;
        right: 30px;
        background-color: #f0f0f0;
        padding: 5px 10px;
        border-radius: 4px;
        font-weight: bold;
        font-size: 14px;
    }

    .form-page .intro {
        background-color: #f9f9f9;
        padding: 15px;
        border-left: 4px solid #2c5aa0;
        margin-bottom: 25px;
        font-size: 14px;
        line-height: 1.5;
    }

    .form-page .section {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px dashed gray;
    }

    /* Ensure printable page text is consistent and not affected by themes */
    .print-forms,
    .print-forms *,
    .print-forms .form-field,
    .print-forms .section-title,
    .print-forms label,
    .print-forms .institute-name,
    .print-forms .campus,
    .print-forms .form-title,
    .print-forms .subtitle,
    .print-forms .intro,
    .print-forms .instructions,
    .print-forms .footer-note,
    .print-forms .print-field-label {
        color: #000 !important;
        background-color: #fff !important;
        border-color: #000 !important;
    }

    .form-page .section-title {
        font-size: 18px;
        font-weight: bold;
        color: #2c5aa0;
        margin-bottom: 15px;
        padding-bottom: 5px;
        border-bottom: 1px solid #eee;
    }

    .form-page .form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 15px;
    }

    .form-page .form-field {
        flex: 1;
        min-width: 200px;
    }

    .form-page label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #444;
    }

    .form-page input[type="text"],
    .form-page input[type="email"],
    .form-page input[type="date"],
    .form-page input[type="number"],
    .form-page select,
    .form-page textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 15px;
        background: white;
        color: #333;
    }

    .form-page input[type="email"] {
        text-transform: lowercase;
    }

    .form-page .radio-group,
    .form-page .checkbox-group {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-top: 5px;
    }

    .form-page .radio-option,
    .form-page .checkbox-option {
        display: flex;
        align-items: center;
    }

    .form-page .radio-option input,
    .form-page .checkbox-option input {
        margin-right: 8px;
        transform: scale(1.2);
    }

    .form-page .instructions {
        background-color: #f0f7ff;
        padding: 10px 15px;
        border-radius: 4px;
        margin: 15px 0;
        font-size: 14px;
        border-left: 3px solid #2c5aa0;
    }

    .form-page table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
    }

    .form-page th {
        background-color: #2c5aa0;
        color: white;
        padding: 12px 8px;
        text-align: center;
        font-weight: 600;
        font-size: 14px;
    }

    .form-page td {
        padding: 12px 8px;
        border-bottom: 1px solid #ddd;
        text-align: center;
    }

    .form-page tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    .form-page .sqd-question {
        text-align: left;
        font-weight: 500;
    }

    .form-page .checkbox-cell {
        width: 16%;
    }

    .form-page .footer-note {
        font-size: 12px;
        color: #777;
        text-align: center;
        margin-top: 30px;
        font-style: italic;
    }

    .required::after {
        content: " *";
        color: #d32f2f;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .filter-row {
            flex-direction: column;
        }

        .filter-group {
            min-width: 100%;
        }

        /* Fix service filter in small screens */
        .filter-group[style*="min-width:220px"] {
            min-width: 100% !important;
            margin-left: 0 !important;
        }

        .filter-actions {
            flex-direction: column;
        }

        .filter-actions .btn {
            width: 100%;
            justify-content: center;
        }

        .form-page .control-no {
            position: static;
            margin-bottom: 15px;
        }

        .form-page .form-row {
            flex-direction: column;
            gap: 10px;
        }

        /* Table responsive adjustments */
        .results-table {
            font-size: 11px;
            min-width: 1200px;
        }

        .results-table th,
        .results-table td {
            padding: 6px;
        }

        .results-card {
            overflow-x: auto;
        }

        .filter-form input,
        .filter-form select {
            font-size: 14px;
        }

        /* Align search + rows-per-page to client_log_report proportions */
        .row.g-3.align-items-end.no-print {
            gap: 12px;
        }

        .col-md-6 {
            width: 100%;
            flex: 0 0 100%;
            max-width: 100%;
        }

        #searchInput {
            width: 100%;
        }

        .form-control,
        .form-select {
            font-size: 14px;
        }
    }

    /* ===== PRINT STYLES ===== */
    /* These styles only apply when printing and are completely isolated */
    @media print {

        /* Reset everything for clean printing */
        *,
        *::before,
        *::after {
            color: #000 !important;
            background: #fff !important;
            background-color: #fff !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        /* Hide navigation and screen-only elements */
        nav,
        .navbar,
        .site-nav,
        .fixed-top,
        .filter-section,
        .screen-view,
        footer,
        .site-footer {
            display: none !important;
            visibility: hidden !important;
            height: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Hide the filter card/header that appears on screen but should not print */
        .card.shadow-sm,
        .card-header,
        .card-body,
        .card {
            display: none !important;
            visibility: hidden !important;
            height: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Reset body for print */
        body,
        html {
            width: 100% !important;
            height: auto !important;
            margin: 0 !important;
            padding: 0 !important;
            background: white !important;
        }

        main {
            padding: 0 !important;
            margin: 0 !important;
        }

        /* Show print forms */
        .print-forms {
            display: block !important;
            margin-top: 0 !important;
            padding-top: 0 !important;
        }

        /* Page setup */
        @page {
            size: legal portrait;
            margin: 0.15cm;
        }

        /* Form page styling */
        .form-page {
            page-break-after: always;
            page-break-inside: avoid;
            margin-bottom: 0;
            box-shadow: none !important;
            padding: 0;
        }

        .form-page:first-child {
            page-break-before: avoid !important;
        }

        /* Avoid extra blank page after the last printed form */
        .form-page:last-child {
            page-break-after: auto !important;
        }

        .form-page .container,
        .print-forms .container {
            width: 99% !important;
            max-width: none !important;
            margin: 0.12cm auto !important;
            padding: 0.25cm 0.4cm !important;
            box-shadow: none !important;
            border: none !important;
        }

        /* Compact typography for print */
        .print-forms,
        .print-forms * {
            font-size: 11px !important;
            line-height: 1.1 !important;
        }

        /* Compact sections */
        .print-forms .section {
            margin-bottom: 6px !important;
            padding-bottom: 6px !important;
        }

        .print-forms .section-title {
            margin-bottom: 6px !important;
            font-size: 12px !important;
        }

        .print-forms .form-row {
            gap: 6px !important;
            margin-bottom: 6px !important;
            display: flex !important;
            flex-wrap: nowrap !important;
            align-items: center !important;
        }

        .print-forms .form-field {
            flex: 1 1 auto !important;
            min-width: 0 !important;
        }

        .print-forms .form-field.sex-field {
            flex: 0 0 30% !important;
        }

        .print-forms .form-field.age-field {
            flex: 0 0 12% !important;
        }

        .print-forms .form-field.region-field {
            flex: 1 1 auto !important;
        }

        /* Compact tables */
        .print-forms table {
            border-collapse: collapse;
            font-size: 11px !important;
        }

        .print-forms th,
        .print-forms td {
            padding: 6px 4px !important;
        }

        /* Plain table headers for print */
        .print-forms thead,
        .print-forms th {
            background: transparent !important;
            background-color: transparent !important;
            color: #000 !important;
            border: 1px solid #000 !important;
        }

        .print-forms td {
            border-bottom: 1px solid #000 !important;
        }

        /* Compact other elements */
        .print-forms .control-no {
            padding: 2px 6px !important;
            font-size: 11px !important;
        }

        .print-forms .intro,
        .print-forms .instructions {
            padding: 6px !important;
            font-size: 11px !important;
        }

        /* Hide footer in print */
        .footer-note,
        .print-footer {
            display: none !important;
        }

        /* Form elements in print */
        .print-forms input[type="text"],
        .print-forms input[type="email"],
        .print-forms input[type="date"],
        .print-forms input[type="number"],
        .print-forms select,
        .print-forms textarea {
            color: #000 !important;
            background: #fff !important;
            border: 1px solid #000 !important;
        }
    }
</style>
{% endblock %}

{% block content %}

<!-- Filter Section (Screen View) -->
<div class="card" style="box-shadow: none !important;">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-filter"></i> Filter CSM Records</h5>
        <div class="d-flex gap-2 no-print" role="group" aria-label="actions">
            <button class="btn btn-sm btn-outline-success" type="button" onclick="window.print()"><i
                    class="fas fa-print"></i> <span class="d-none d-md-inline">Print</span></button>
            <a class="btn btn-sm btn-outline-primary" href="/csm-report?export=csv"><i class="fas fa-download"></i>
                <span class="d-none d-md-inline">Export CSV</span></a>
            <a class="btn btn-sm btn-outline-secondary" href="/csm-report"><i class="fas fa-times"></i> <span
                    class="d-none d-md-inline">Clear</span></a>
        </div>
    </div>

    <div>
        <div class="filter-section screen-view">
            <form method="get" action="/csm-report" class="filter-form" id="filter-form" data-no-ajax="true">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="start_date"><i class="fas fa-calendar-alt"></i> Start Date:</label>
                        <input type="date" id="start_date" name="start_date" value="{{ filters.start_date or '' }}">
                    </div>
                    <div class="filter-group">
                        <label for="end_date"><i class="fas fa-calendar-alt"></i> End Date:</label>
                        <input type="date" id="end_date" name="end_date" value="{{ filters.end_date or '' }}">
                    </div>
                    <div class="filter-group">
                        <label for="gender"><i class="fas fa-venus-mars"></i> Gender:</label>
                        <select id="gender" name="gender">
                            <option value="">All</option>
                            {% for gen in genders %}
                            <option value="{{ gen }}" {% if filters.gender==gen %}selected{% endif %}>{{ gen }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="region"><i class="fas fa-map-marker-alt"></i> Region:</label>
                        <select id="region" name="region">
                            <option value="">All Regions</option>
                            {% for reg in regions %}
                            <option value="{{ reg }}" {% if filters.region==reg %}selected{% endif %}>{{ reg }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="age_min"><i class="fas fa-birthday-cake"></i> Age Min:</label>
                        <input type="number" id="age_min" name="age_min" min="0" value="{{ filters.age_min or '' }}">
                    </div>
                    <div class="filter-group">
                        <label for="age_max"><i class="fas fa-birthday-cake"></i> Age Max:</label>
                        <input type="number" id="age_max" name="age_max" min="0" value="{{ filters.age_max or '' }}">
                    </div>
                    <!-- other filter groups above remain unchanged -->
                    <div style="flex: 1 1 100%;"></div>
                    <div class="filter-group" style="min-width:220px; margin-left: auto;">
                        <label for="service"><i class="fas fa-concierge-bell"></i> Service:</label>
                        <select id="service" name="service"
                            style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                            <option value="">All Services</option>
                            {% for svc in services %}
                            <option value="{{ svc }}" {% if filters.service==svc %}selected{% endif %}>{{ svc }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- Filter button removed: filters now apply on input/select changes -->
                </div>
            </form>
        </div>
    </div>
    <div class="card-body border-bottom">
        <div class="row g-3 align-items-end">
            <div class="col-md-6 no-print">
                <label for="searchInput" class="form-label"><i class="fas fa-search"></i> Search</label>
                <input type="text" class="form-control" id="searchInput" placeholder="Search by any column">
            </div>
            <div class="col-md-6 no-print">
                <label for="limit" class="form-label"><i class="fas fa-list"></i> Rows Displayed</label>
                <form method="get" action="/csm-report"
                    style="display: inline-flex; align-items: center; gap: 8px; width: 100%;">
                    <select id="limit" name="limit" class="form-select" onchange="this.form.submit()">
                        <option value="25" {% if filters.limit=='25' %}selected{% endif %}>25</option>
                        <option value="50" {% if filters.limit=='50' %}selected{% endif %}>50</option>
                        <option value="100" {% if filters.limit=='100' %}selected{% endif %}>100</option>
                        <option value="all" {% if filters.limit=='all' %}selected{% endif %}>All</option>
                    </select>
                    {% for key, value in filters.items() %}
                    {% if key != 'limit' and value %}
                    <input type="hidden" name="{{ key }}" value="{{ value }}">
                    {% endif %}
                    {% endfor %}
                </form>
            </div>
        </div>
    </div>

    <div class="card-body p-0">
        <div class="screen-view">

            <div class="results-card">
                <div class="table-responsive">
                    <table id="csm-report" class="results-table">
                        <thead>
                            <tr>
                                <th>CONTROL #</th>
                                <th>DATE</th>
                                <th>CLIENT TYPE</th>
                                <th>GENDER</th>
                                <th>AGE</th>
                                <th>REGION</th>
                                <th>EMAIL</th>
                                <th>SERVICES</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% include 'partials/csm_report_rows.html' %}
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Print View: Full CSM Forms -->
<div class="print-forms">
    {% include 'partials/csm_report_print_forms.html' %}
</div>

{% endblock %}

{% block scripts %}
<script>
    // Unified JSON-based live filters for CSM report
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('searchInput');
        const filterForm = document.getElementById('filter-form');
        if (!filterForm) return;

        let debounceTimer = null;
        function collectFilters(q) {
            const fd = new FormData(filterForm);
            const obj = {};
            for (const [k, v] of fd.entries()) {
                if (v !== null && String(v).trim() !== '') obj[k] = v;
            }
            if (typeof q !== 'undefined') obj.q = q;
            return obj;
        }

        function updateUrlFromFilters(obj) {
            const parts = [];
            for (const k in obj) {
                if (obj[k] !== null && obj[k] !== undefined && String(obj[k]).length) parts.push(encodeURIComponent(k) + '=' + encodeURIComponent(obj[k]));
            }
            const qs = parts.join('&');
            const base = window.location.pathname || '/csm-report';
            const newUrl = qs ? (base + '?' + qs) : base;
            history.replaceState({}, '', newUrl);
        }

        function applyFilters(q) {
            const payload = collectFilters(q);
            // send JSON to server and expect JSON { html: '...' }
            $.ajax({
                url: '/csm-report',
                type: 'POST',
                contentType: 'application/json',
                dataType: 'json',
                data: JSON.stringify(payload),
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                success: function (data) {
                    if (!data) return;

                    // Update screen view table rows
                    if (data.html) {
                        const tbody = document.querySelector('#csm-report tbody');
                        if (tbody) tbody.innerHTML = data.html;
                    }

                    // Update print view forms
                    if (data.print_html) {
                        const printContainer = document.querySelector('.print-forms');
                        if (printContainer) printContainer.innerHTML = data.print_html;
                    }
                },
                error: function (xhr, status, err) { console.warn('Filter request failed', status, err); }
            });

            // update URL for bookmarking
            updateUrlFromFilters(collectFilters(q));
        }

        function debouncedApply(q) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(function () { applyFilters(q); }, 300);
        }

        // wire inputs/selects inside filter form
        const inputs = filterForm.querySelectorAll('input, select');
        inputs.forEach(function (el) {
            const ev = (el.tagName.toLowerCase() === 'select' || el.type === 'date' || el.type === 'number') ? 'change' : 'input';
            el.addEventListener(ev, function () { debouncedApply(searchInput ? searchInput.value : undefined); });
        });

        // wire search box
        if (searchInput) {
            searchInput.addEventListener('input', function () { debouncedApply(this.value || ''); });
        }
    });
</script>

<script>
    // Use jQuery AJAX to submit forms on this page without full page reloads.
    // - For GET responses: attempt to replace the `.results-card` area with returned HTML.
    // - For JSON responses: honor `{ "redirect": "/path" }` or `{ "message": "..." }`.
    // Skip forms with `data-no-ajax="true"` if needed.
    (function () {
        if (typeof window.jQuery === 'undefined') return;
        var $ = window.jQuery;

        function replaceResultsCardFromHtml(html) {
            try {
                var parsed = $('<div>').append($.parseHTML(html));
                var newCard = parsed.find('.results-card').first();
                if (newCard.length) {
                    $('.results-card').replaceWith(newCard);
                    return true;
                }
            } catch (e) { }
            return false;
        }

        $(function () {
            $('form').on('submit', function (e) {
                var $form = $(this);
                if ($form.data('no-ajax')) return true;
                e.preventDefault();

                var method = ($form.attr('method') || 'GET').toUpperCase();
                var url = $form.attr('action') || window.location.href;
                var isMultipart = ($form.attr('enctype') || '').toLowerCase() === 'multipart/form-data';

                var ajaxOptions = { url: url, type: method, headers: { 'X-Requested-With': 'XMLHttpRequest' } };

                if (method === 'GET' && !isMultipart) {
                    ajaxOptions.data = $form.serialize();
                } else if (isMultipart) {
                    ajaxOptions.data = new FormData(this);
                    ajaxOptions.processData = false;
                    ajaxOptions.contentType = false;
                } else {
                    ajaxOptions.data = $form.serialize();
                }

                $.ajax(ajaxOptions).done(function (resp, textStatus, xhr) {
                    var ct = (xhr.getResponseHeader('Content-Type') || '').toLowerCase();

                    // JSON response handling
                    if (ct.indexOf('application/json') > -1 || (typeof resp === 'object' && resp !== null)) {
                        var data = (typeof resp === 'string') ? JSON.parse(resp) : resp;
                        if (data.redirect) { window.location = data.redirect; return; }
                        if (data.message) { alert(data.message); return; }
                    }

                    // HTML response handling: try to replace .results-card
                    if (typeof resp === 'string') {
                        if (!replaceResultsCardFromHtml(resp)) {
                            if (resp.indexOf('<html') > -1) {
                                document.open(); document.write(resp); document.close();
                            } else {
                                location.reload();
                            }
                        } else {
                            // Update URL for GET forms so filters are reflected
                            if (method === 'GET') {
                                var base = url.split('?')[0];
                                var serialized = $form.serialize();
                                var newUrl = serialized ? (base + '?' + serialized) : base;
                                history.replaceState({}, '', newUrl);
                            }
                        }
                    } else {
                        location.reload();
                    }
                }).fail(function (xhr) {
                    alert('Request failed: ' + (xhr.status ? xhr.status + ' ' + xhr.statusText : 'Network error'));
                });

                return false;
            });

            // Ensure selects that call `this.form.submit()` still trigger AJAX handler
            // but skip selects inside forms marked data-no-ajax
            $('select').on('change', function () {
                var $form = $(this).closest('form');
                if ($form.length) {
                    if ($form.data('no-ajax')) return;
                    $form.trigger('submit');
                }
            });
        });
    })();
</script>
{% endblock %}