{% extends 'base.html' %}
{% block title %}Edit Client â€” HR Logbook{% endblock %}

{% block head_extra %}
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<style>
    .media-frame {
        width: 100%;
        aspect-ratio: 4 / 3;
        /* modern browsers */
        max-height: 420px;
        background: #0f1720;
        border-radius: 8px;
        border: 3px solid rgba(13, 110, 253, 0.08);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
    }

    .media-frame video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    /* Make preview match live preview â€” use cover so framing matches */
    .media-frame img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    /* Camera guide: subtle broken square shown over the live preview */
    #face-guide {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 60%;
        height: 60%;
        pointer-events: none;
        z-index: 6;
    }

    #face-guide .fg-corner {
        position: absolute;
        width: clamp(32px, 8%, 56px);
        height: clamp(32px, 8%, 56px);
        box-sizing: border-box;
        border-radius: 4px;
        border-color: rgba(154, 166, 188, 0.28);
        border-style: solid;
    }

    #face-guide .top-left {
        top: 0;
        left: 0;
        border-right: none;
        border-bottom: none;
    }

    #face-guide .top-right {
        top: 0;
        right: 0;
        border-left: none;
        border-bottom: none;
    }

    #face-guide .bottom-right {
        bottom: 0;
        right: 0;
        border-left: none;
        border-top: none;
    }

    #face-guide .bottom-left {
        bottom: 0;
        left: 0;
        border-right: none;
        border-top: none;
    }

    #previewBox {
        padding: .5rem;
        background: #f8fafc;
    }

    .message-overlay {
        position: absolute;
        top: 10px;
        left: 10px;
        right: 10px;
        padding: 6px 10px;
        border-radius: 6px;
        color: white;
        font-weight: bold;
        text-align: center;
        z-index: 10;
        display: none;
        font-size: 12px;
        line-height: 1.2;
        word-wrap: break-word;
    }

    .message-overlay.success {
        background-color: rgba(25, 135, 84, 1);
    }

    .message-overlay.error {
        background-color: rgba(220, 53, 69, 1);
    }

    .message-overlay.normal {
        background-color: rgba(13, 110, 253, 0.9);
    }
</style>
{% endblock %}


{% block content %}
<div class="card shadow-sm mx-auto" style="max-width:760px;">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-edit"></i> Edit Client</h5>
    </div>
    <div class="card-body">
        <form method="post">
            <input class="form-control" type="hidden" name="client_id" value="{{ client.client_id }}" required>
            <div class="mb-3">
                <label class="form-label"><i class="fas fa-user"></i> Full Name</label>
                <input class="form-control" type="text" name="full_name" value="{{ client.full_name }}" required>
            </div>
            <div class="mb-3">
                <label class="form-label"><i class="fas fa-building"></i> Department</label>
                <input class="form-control" type="text" name="department" value="{{ client.department }}">
            </div>
            <div class="mb-3">
                <label class="form-label"><i class="fas fa-tags"></i> Client Type</label>
                <select class="form-select" name="client_type">
                    <option value="" {% if not client.client_type %}selected{% endif %}>Select</option>
                    <option value="EMPLOYEE" {% if client.client_type=='EMPLOYEE' %}selected{% endif %}>EMPLOYEE
                    </option>
                    <option value="STUDENT" {% if client.client_type=='STUDENT' %}selected{% endif %}>STUDENT
                    </option>
                    <option value="APPLICANT" {% if client.client_type=='APPLICANT' %}selected{% endif %}>
                        APPLICANT</option>
                    <option value="VISITOR" {% if client.client_type=='VISITOR' %}selected{% endif %}>VISITOR
                    </option>
                    <option value="OTHER" {% if client.client_type=='OTHER' %}selected{% endif %}>OTHER</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label"><i class="fas fa-venus-mars"></i> Gender</label>
                <select class="form-select" name="gender">
                    <option value="" {% if not client.gender %}selected{% endif %}>Select</option>
                    <option value="MALE" {% if client.gender=='MALE' %}selected{% endif %}>MALE</option>
                    <option value="FEMALE" {% if client.gender=='FEMALE' %}selected{% endif %}>FEMALE</option>
                    <option value="OTHER" {% if client.gender=='OTHER' %}selected{% endif %}>OTHER</option>
                    <option value="PREFER_NOT_TO_SAY" {% if client.gender=='PREFER_NOT_TO_SAY' %}selected{% endif %}>
                        PREFER NOT TO SAY</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label"><i class="fas fa-birthday-cake"></i> Age</label>
                <input class="form-control" type="number" name="age" value="{{ client.age or '' }}" min="0" max="150">
            </div>
            <div class="mb-3">
                <label class="form-label"><i class="fas fa-camera"></i> Update Photo (Optional)</label>
                <div class="row g-2">
                    <div class="col-md-6">
                        <div class="mx-auto shadow-sm rounded media-frame" id="cameraCanvas" style="cursor: pointer;"
                            title="Click to start camera">
                            <video id="video" autoplay playsinline style="display:none; border-radius:6px;"></video>

                            <!-- face position guide (subtle broken square corners) -->
                            <div id="face-guide" aria-hidden="true">
                                <div class="fg-corner top-left"></div>
                                <div class="fg-corner top-right"></div>
                                <div class="fg-corner bottom-right"></div>
                                <div class="fg-corner bottom-left"></div>
                            </div>
                            <div id="camera-placeholder" class="text-center text-muted" style="color:#9aa6bc">
                                <div style="font-size:38px; opacity:0.6">ðŸ“·</div>
                                <div style="margin-top:6px;">Camera Preview</div>
                            </div>
                            <canvas id="canvas" width="420" height="320"
                                style="display:none; position:absolute; top:0; left:0; border-radius:6px;"></canvas>
                        </div>

                        <div class="mt-3 text-center">
                            <button id="camera-action" type="button" class="btn btn-outline-primary me-2"><i
                                    class="fas fa-play"></i> Start Camera</button>
                            <button id="file-toggle" type="button" class="btn btn-outline-secondary"><i
                                    class="fas fa-upload"></i> Use file</button>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="mb-2">
                            <div class="border rounded p-0 media-frame" id="previewBox">
                                {% if client.client_id %}
                                <img src="/static/clients/{{ client.client_id }}.jpg"
                                    onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
                                    style="width:100%; height:100%; object-fit:cover;">
                                <div style="display:none; text-align:center; width:100%;">
                                    <span class="text-muted">No image captured | Preview</span>
                                </div>
                                {% else %}
                                <div style="text-align:center; width:100%;"> <span class="text-muted">No image captured
                                        | Preview</span></div>
                                {% endif %}
                                <div id="message-overlay" class="message-overlay"></div>
                            </div>
                        </div>

                        <div id="fileArea" style="display:none;">
                            <label for="fileInput" class="form-label">Upload image</label>
                            <input id="fileInput" class="form-control" type="file" accept="image/*">
                            <div class="form-text">If camera is unavailable, upload a photo (JPEG/PNG). Max 5MB.</div>
                        </div>
                    </div>
                </div>
                <input type="hidden" name="photo_data" id="photo_data">
            </div>

            <div class="d-flex gap-2 justify-content-end">
                <button class="btn btn-success" type="submit"><i class="fas fa-save"></i> Update</button>
                <a class="btn btn-outline-secondary" href="/clients"><i class="fas fa-arrow-left"></i> Back</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Check if success=1 is in the URL
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('success') === '1') {
            // Show the success modal
            const successModal = new bootstrap.Modal(document.getElementById('successModal'));
            document.getElementById('successMessage').textContent = 'Client record updated successfully!';
            successModal.show();
        }
    });

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const preview = document.getElementById('preview');
    const placeholder = document.getElementById('camera-placeholder');
    const actionBtn = document.getElementById('camera-action');
    const photoInput = document.getElementById('photo_data');
    const previewBox = document.getElementById('previewBox');
    const fileToggle = document.getElementById('file-toggle');
    const fileArea = document.getElementById('fileArea');
    const fileInput = document.getElementById('fileInput');
    let messageOverlay = document.getElementById('message-overlay');
    const cameraCanvas = document.getElementById('cameraCanvas');
    let stream = null;
    let cameraState = 'stopped'; // 'stopped' | 'started' | 'captured'
    let faceVerified = false; // Track if face has been verified
    let messageTimeout = null; // To manage message timeout

    // Function to show message overlay
    function showMessage(message, type) {
        console.log('Showing message:', message, 'type:', type);
        if (!messageOverlay) messageOverlay = document.getElementById('message-overlay');
        messageOverlay.textContent = message;
        messageOverlay.className = `message-overlay ${type}`;
        messageOverlay.style.display = 'block';
        // Clear any existing timeout
        if (messageTimeout) clearTimeout(messageTimeout);
        // Hide after 4 seconds
        messageTimeout = setTimeout(() => {
            messageOverlay.style.display = 'none';
        }, 4000);
    }

    // Function to hide message overlay
    function hideMessage() {
        if (!messageOverlay) messageOverlay = document.getElementById('message-overlay');
        messageOverlay.style.display = 'none';
        if (messageTimeout) {
            clearTimeout(messageTimeout);
            messageTimeout = null;
        }
    }

    // Combined camera action function
    async function cameraAction() {
        try {
            if (cameraState === 'stopped') {
                stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } });
                video.srcObject = stream;
                video.style.display = 'block';
                placeholder.style.display = 'none';
                actionBtn.textContent = 'Capture';
                cameraState = 'started';
                return;
            }

            if (cameraState === 'started') {
                if (!stream) { alert('Start the camera first'); return; }

                const ctx = canvas.getContext('2d');
                // Calculate the visible area in video coordinates to match object-fit: cover
                const containerW = 420;
                const containerH = 320;
                const vw = video.videoWidth || 420;
                const vh = video.videoHeight || 320;
                const scale = Math.max(containerW / vw, containerH / vh);
                const scaledW = vw * scale;
                const scaledH = vh * scale;
                let sourceX = 0, sourceY = 0, sourceW = vw, sourceH = vh;
                if (scaledW > containerW) {
                    // crop horizontally
                    const cropAmount = (scaledW - containerW) / scale;
                    sourceX = cropAmount / 2;
                    sourceW = vw - cropAmount;
                } else {
                    // crop vertically
                    const cropAmount = (scaledH - containerH) / scale;
                    sourceY = cropAmount / 2;
                    sourceH = vh - cropAmount;
                }
                // Set canvas size to the cropped visible area, then scale down if needed
                let targetW = sourceW;
                let targetH = sourceH;
                const MAX_W = 800;
                if (targetW > MAX_W) {
                    const scaleDown = MAX_W / targetW;
                    targetW = Math.round(targetW * scaleDown);
                    targetH = Math.round(targetH * scaleDown);
                }
                canvas.width = targetW;
                canvas.height = targetH;
                // Draw only the visible cropped part
                ctx.drawImage(video, sourceX, sourceY, sourceW, sourceH, 0, 0, targetW, targetH);
                const dataUrl = canvas.toDataURL('image/jpeg', 0.9);

                // Clear all children of previewBox except message-overlay
                // Simplest way to ensure clean state including overlay is:
                previewBox.innerHTML = '';
                previewBox.appendChild(messageOverlay);

                const img = document.createElement('img'); img.src = dataUrl; img.style.width = '100%'; img.style.height = '100%'; img.style.objectFit = 'cover';
                previewBox.insertBefore(img, messageOverlay);
                video.style.display = 'none';
                actionBtn.textContent = 'Stop Camera';
                cameraState = 'captured';
                photoInput.value = dataUrl;

                // Verify face
                const verificationResult = await verifyFace(dataUrl);
                if (verificationResult.ok) {
                    faceVerified = true;
                    showMessage('Face verified successfully!', 'success');
                } else {
                    faceVerified = false;
                    showMessage(verificationResult.message, 'error');
                }
                return;
            }

            if (cameraState === 'captured') {
                if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
                video.srcObject = null;
                video.style.display = 'none';
                placeholder.style.display = 'block';
                photoInput.value = '';
                faceVerified = false; // Reset face verification
                actionBtn.textContent = 'Start Camera';
                cameraState = 'stopped';

                // Reset preview to original image or placeholder
                // Reset preview to original image or placeholder
                previewBox.innerHTML = `
                {% if client.client_id %}
                <img src="/static/clients/{{ client.client_id }}.jpg" onerror="this.onerror=null; this.src=''; this.parentElement.innerHTML='<div style=\\'text-align:center; width:100%;\\'> <span class=\\'text-muted\\'>No image captured | Preview</span></div>';" style="width:100%; height:100%; object-fit:cover;">
                <div style="display:none; text-align:center; width:100%;"> 
                    <span class="text-muted">No image captured | Preview</span>
                </div>
                {% else %}
                <div style="text-align:center; width:100%;"> <span class="text-muted">No image captured | Preview</span></div>
                {% endif %}
                <div id="message-overlay" class="message-overlay"></div>
                `;
                // Re-get message overlay reference since we replaced innerHTML
                messageOverlay = document.getElementById('message-overlay');

                hideMessage(); // Hide any existing message
                return;
            }
        } catch (err) {
            alert('Camera error: ' + err.message);
        }
    }

    // Button click handler
    actionBtn.addEventListener('click', cameraAction);

    // Make the entire camera canvas clickable
    if (cameraCanvas) {
        cameraCanvas.addEventListener('click', (e) => {
            // Prevent triggering if clicking on the button itself to avoid double execution
            if (e.target === actionBtn) return;
            cameraAction();
        });
    }

    // File upload fallback
    fileToggle.addEventListener('click', () => {
        if (fileArea.style.display === 'none' || fileArea.style.display === '') {
            fileArea.style.display = 'block';
            actionBtn.disabled = true;
            fileToggle.textContent = 'Use camera';
        } else {
            fileArea.style.display = 'none';
            actionBtn.disabled = false;
            fileToggle.textContent = 'Use file';
        }
    });

    // Allow re-selecting the same file
    if (fileInput) {
        fileInput.addEventListener('click', function () {
            this.value = '';
        });

        fileInput.addEventListener('change', async (e) => {
            const f = e.target.files && e.target.files[0];
            if (!f) return;
            if (f.size > 5 * 1024 * 1024) { alert('File too large (max 5MB)'); return; }

            // Reset verification state
            faceVerified = false;
            photoInput.value = '';
            hideMessage();

            const reader = new FileReader();
            reader.onload = async function (ev) {
                const data = ev.target.result;
                photoInput.value = data;

                // Clear all children of previewBox except message-overlay
                previewBox.innerHTML = '';
                previewBox.appendChild(messageOverlay);

                const img = document.createElement('img'); img.src = data; img.style.width = '100%'; img.style.height = '100%'; img.style.objectFit = 'cover';
                previewBox.insertBefore(img, messageOverlay);

                // Verify face
                showMessage('Verifying face...', 'normal');
                const verificationResult = await verifyFace(data);
                if (verificationResult.ok) {
                    faceVerified = true;
                    showMessage('Face verified successfully!', 'success');
                } else {
                    faceVerified = false;
                    showMessage(verificationResult.message, 'error');
                }
            };
            reader.readAsDataURL(f);
        });
    }

    // Function to verify face using the server endpoint
    async function verifyFace(photoData) {
        try {
            const response = await fetch('/verify_face', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({ photo_data: photoData })
            });
            const result = await response.json();
            return result;
        } catch (error) {
            console.error('Face verification error:', error);
            return { ok: false, message: 'Error verifying face. Please try again.' };
        }
    }
</script>
{% endblock %}