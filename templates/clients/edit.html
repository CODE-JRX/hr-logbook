{% extends 'base.html' %}
{% block title %}Edit Client â€” HR Logbook{% endblock %}

{% block head_extra %}
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<style>
    .media-frame {
        width: 100%;
        aspect-ratio: 4 / 3;
        /* modern browsers */
        max-height: 420px;
        background: #0f1720;
        border-radius: 8px;
        border: 3px solid rgba(13, 110, 253, 0.08);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
    }

    .media-frame video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    /* Make preview match live preview â€” use cover so framing matches */
    .media-frame img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    /* Camera guide: subtle broken square shown over the live preview */
    #face-guide {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 60%;
        height: 60%;
        pointer-events: none;
        z-index: 6;
    }

    #face-guide .fg-corner {
        position: absolute;
        width: clamp(32px, 8%, 56px);
        height: clamp(32px, 8%, 56px);
        box-sizing: border-box;
        border-radius: 4px;
        border-color: rgba(154, 166, 188, 0.28);
        border-style: solid;
    }

    #face-guide .top-left {
        top: 0;
        left: 0;
        border-right: none;
        border-bottom: none;
    }

    #face-guide .top-right {
        top: 0;
        right: 0;
        border-left: none;
        border-bottom: none;
    }

    #face-guide .bottom-right {
        bottom: 0;
        right: 0;
        border-left: none;
        border-top: none;
    }

    #face-guide .bottom-left {
        bottom: 0;
        left: 0;
        border-right: none;
        border-top: none;
    }

    #previewBox {
        padding: .5rem;
        background: #f8fafc;
    }

    .message-overlay {
        position: absolute;
        top: 10px;
        left: 10px;
        right: 10px;
        padding: 6px 10px;
        border-radius: 6px;
        color: white;
        font-weight: bold;
        text-align: center;
        z-index: 10;
        display: none;
        font-size: 12px;
        line-height: 1.2;
        word-wrap: break-word;
    }

    .message-overlay.success {
        background-color: rgba(25, 135, 84, 1);
    }

    .message-overlay.error {
        background-color: rgba(220, 53, 69, 1);
    }

    .message-overlay.normal {
        background-color: rgba(13, 110, 253, 0.9);
    }
</style>
{% endblock %}


{% block content %}
<div class="card shadow-sm mx-auto" style="max-width:760px;">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-edit"></i> Edit Client</h5>
    </div>
    <div class="card-body">
        <form method="post">
            <input class="form-control" type="hidden" name="client_id" value="{{ client.client_id }}" required>
            <div class="mb-3">
                <label class="form-label"><i class="fas fa-user"></i> Full Name</label>
                <input class="form-control" type="text" name="full_name" value="{{ client.full_name }}" required>
            </div>
            <div class="mb-3">
                <label class="form-label"><i class="fas fa-building"></i> Department</label>
                <input class="form-control" type="text" name="department" value="{{ client.department }}">
            </div>
            <div class="mb-3">
                <label class="form-label"><i class="fas fa-tags"></i> Client Type</label>
                <select class="form-select" name="client_type">
                    <option value="" {% if not client.client_type %}selected{% endif %}>Select</option>
                    <option value="EMPLOYEE" {% if client.client_type=='EMPLOYEE' %}selected{% endif %}>EMPLOYEE
                    </option>
                    <option value="STUDENT" {% if client.client_type=='STUDENT' %}selected{% endif %}>STUDENT
                    </option>
                    <option value="APPLICANT" {% if client.client_type=='APPLICANT' %}selected{% endif %}>
                        APPLICANT</option>
                    <option value="VISITOR" {% if client.client_type=='VISITOR' %}selected{% endif %}>VISITOR
                    </option>
                    <option value="OTHER" {% if client.client_type=='OTHER' %}selected{% endif %}>OTHER</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label"><i class="fas fa-venus-mars"></i> Gender</label>
                <select class="form-select" name="gender">
                    <option value="" {% if not client.gender %}selected{% endif %}>Select</option>
                    <option value="MALE" {% if client.gender=='MALE' %}selected{% endif %}>MALE</option>
                    <option value="FEMALE" {% if client.gender=='FEMALE' %}selected{% endif %}>FEMALE</option>
                    <option value="OTHER" {% if client.gender=='OTHER' %}selected{% endif %}>OTHER</option>
                    <option value="PREFER_NOT_TO_SAY" {% if client.gender=='PREFER_NOT_TO_SAY' %}selected{% endif %}>
                        PREFER NOT TO SAY</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label"><i class="fas fa-birthday-cake"></i> Age</label>
                <input class="form-control" type="number" name="age" value="{{ client.age or '' }}" min="0" max="150">
            </div>
            <div class="mb-3">
                <label class="form-label"><i class="fas fa-camera"></i> Update Photos (3 Angles Required)</label>
                <div class="row g-2">
                    <!-- Main Camera Area -->
                    <div class="col-md-7">
                        <div class="mx-auto shadow-sm rounded media-frame" id="cameraCanvas" style="cursor: pointer;"
                            title="Click to start camera">
                            <video id="video" autoplay playsinline style="display:none; border-radius:6px;"></video>

                            <!-- face position guide (subtle broken square corners) -->
                            <div id="face-guide" aria-hidden="true">
                                <div class="fg-corner top-left"></div>
                                <div class="fg-corner top-right"></div>
                                <div class="fg-corner bottom-right"></div>
                                <div class="fg-corner bottom-left"></div>
                            </div>
                            <div id="camera-placeholder" class="text-center text-muted" style="color:#9aa6bc">
                                <div style="font-size:38px; opacity:0.6">ðŸ“·</div>
                                <div style="margin-top:6px;">Camera Preview</div>
                            </div>
                            <!-- Canvas for capturing -->
                            <canvas id="canvas" width="420" height="320" style="display:none;"></canvas>
                        </div>

                        <div class="mt-3 text-center">
                            <button id="camera-action" type="button" class="btn btn-outline-primary me-2"><i
                                    class="fas fa-play"></i> Start Camera</button>
                            <div id="capture-controls" class="d-inline-block" style="display:none !important;">
                                <button id="capture-btn" type="button" class="btn btn-outline-primary" disabled><i
                                        class="fas fa-camera"></i>
                                    Capture <span id="capture-target">Center</span></button>
                                <button id="retake-btn" type="button" class="btn btn-secondary ms-2"
                                    style="display:none;"><i class="fas fa-redo"></i> Retake All</button>
                            </div>
                        </div>
                        <div class="mt-2 text-center">
                            <small class="text-muted" id="instruction-text">To update photos, please capture 3 angles:
                                Center, Left, Right.</small>
                        </div>
                    </div>

                    <!-- Thumbnails Area -->
                    <div class="col-md-5">
                        <!-- Current Photo Display -->


                        <div class="d-flex flex-column gap-2">
                            <!-- Center Preview -->
                            <div class="border rounded p-1 position-relative"
                                style="background:#f8fafc; height: 80px; display: flex; align-items: center; justify-content: center;">
                                <img id="preview-center" style="max-height: 100%; max-width: 100%; display: none;" />
                                <span class="text-muted small position-absolute" id="label-center"
                                    style="opacity: 0.5;">Center View</span>
                                <div class="position-absolute top-0 end-0 p-1" id="tick-center" style="display:none;"><i
                                        class="fas fa-check-circle text-success"></i></div>
                            </div>
                            <!-- Left Preview -->
                            <div class="border rounded p-1 position-relative"
                                style="background:#f8fafc; height: 80px; display: flex; align-items: center; justify-content: center;">
                                <img id="preview-left" style="max-height: 100%; max-width: 100%; display: none;" />
                                <span class="text-muted small position-absolute" id="label-left"
                                    style="opacity: 0.5;">Left Side View</span>
                                <div class="position-absolute top-0 end-0 p-1" id="tick-left" style="display:none;"><i
                                        class="fas fa-check-circle text-success"></i></div>
                            </div>
                            <!-- Right Preview -->
                            <div class="border rounded p-1 position-relative"
                                style="background:#f8fafc; height: 80px; display: flex; align-items: center; justify-content: center;">
                                <img id="preview-right" style="max-height: 100%; max-width: 100%; display: none;" />
                                <span class="text-muted small position-absolute" id="label-right"
                                    style="opacity: 0.5;">Right Side View</span>
                                <div class="position-absolute top-0 end-0 p-1" id="tick-right" style="display:none;"><i
                                        class="fas fa-check-circle text-success"></i></div>
                            </div>
                        </div>

                        <div id="message-overlay" class="message-overlay mt-2 position-relative" style="display:none;">
                        </div>

                        <div class="mt-3">
                            <button class="btn btn-success w-100" type="submit"><i class="fas fa-save"></i>
                                Update</button>
                            <a class="btn btn-outline-secondary w-100 mt-2" href="/clients"><i
                                    class="fas fa-arrow-left"></i> Back</a>
                        </div>
                    </div>
                </div>
                <!-- Hidden inputs for 3 angles -->
                <input type="hidden" name="photo_data_center" id="photo_data_center">
                <input type="hidden" name="photo_data_left" id="photo_data_left">
                <input type="hidden" name="photo_data_right" id="photo_data_right">


        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Check if success=1 is in the URL
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('success') === '1') {
            // Show the success modal
            const successModal = new bootstrap.Modal(document.getElementById('successModal'));
            document.getElementById('successMessage').textContent = 'Client record updated successfully!';
            successModal.show();
        }
    });

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const placeholder = document.getElementById('camera-placeholder');
    const actionBtn = document.getElementById('camera-action');
    const captureControls = document.getElementById('capture-controls');
    const captureBtn = document.getElementById('capture-btn');
    const retakeBtn = document.getElementById('retake-btn');
    const captureTarget = document.getElementById('capture-target');
    const instructionText = document.getElementById('instruction-text');
    const messageOverlay = document.getElementById('message-overlay');
    const cameraCanvas = document.getElementById('cameraCanvas');
    const saveBtn = document.querySelector('button[type="submit"]'); // The Update Button

    // Input fields
    const inputs = {
        0: document.getElementById('photo_data_center'),
        1: document.getElementById('photo_data_left'),
        2: document.getElementById('photo_data_right')
    };

    // Preview elements
    const previews = {
        0: document.getElementById('preview-center'),
        1: document.getElementById('preview-left'),
        2: document.getElementById('preview-right')
    };

    const ticks = {
        0: document.getElementById('tick-center'),
        1: document.getElementById('tick-left'),
        2: document.getElementById('tick-right')
    };

    let stream = null;
    let cameraState = 'stopped'; // 'stopped' | 'started'
    let captureStep = 0; // 0=Center, 1=Left, 2=Right, 3=Done

    function showMessage(message, type) {
        messageOverlay.textContent = message;
        messageOverlay.className = `message-overlay ${type}`;
        messageOverlay.style.display = 'block';
        setTimeout(() => {
            messageOverlay.style.display = 'none';
        }, 4000);
    }

    async function startCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } });
            video.srcObject = stream;
            video.style.display = 'block';
            placeholder.style.display = 'none';
            actionBtn.style.display = 'none';
            captureControls.style.display = 'inline-block';
            captureControls.style.setProperty('display', 'inline-block', 'important');

            captureBtn.disabled = false;
            cameraState = 'started';
            updateUIForStep();
        } catch (err) {
            alert('Camera error: ' + err.message);
        }
    }

    function stopCamera() {
        if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
        video.srcObject = null;
        video.style.display = 'none';
        placeholder.style.display = 'block';
        actionBtn.style.display = 'inline-block';
        actionBtn.textContent = 'Start Camera';
        captureControls.style.display = 'none';
        cameraState = 'stopped';
    }

    function updateUIForStep() {
        // Enforce all-or-nothing for photo update during capture
        // If we are in the middle of capturing (step 0, 1, 2), we should distinct visually
        // but verification logic is in the form submit.

        if (captureStep === 0) {
            captureTarget.textContent = "Center";
            instructionText.textContent = "Please look at the camera (Center).";
            captureBtn.disabled = false;
            captureBtn.style.display = 'inline-block';
            retakeBtn.style.display = 'none';
        } else if (captureStep === 1) {
            captureTarget.textContent = "Left Side";
            instructionText.textContent = "Please turn slightly to show your LEFT side.";
        } else if (captureStep === 2) {
            captureTarget.textContent = "Right Side";
            instructionText.textContent = "Please turn slightly to show your RIGHT side.";
        } else if (captureStep === 3) {
            captureBtn.style.display = 'none';
            retakeBtn.style.display = 'inline-block';
            instructionText.textContent = "All angles captured. Ready to Update.";
            stopCamera();
        }
    }

    function capture() {
        if (captureStep > 2) return;

        const ctx = canvas.getContext('2d');
        const containerW = 420;
        const containerH = 320;
        const vw = video.videoWidth || 420;
        const vh = video.videoHeight || 320;
        const scale = Math.max(containerW / vw, containerH / vh);
        const scaledW = vw * scale;
        const scaledH = vh * scale;
        let sourceX = 0, sourceY = 0, sourceW = vw, sourceH = vh;

        if (scaledW > containerW) {
            const cropAmount = (scaledW - containerW) / scale;
            sourceX = cropAmount / 2;
            sourceW = vw - cropAmount;
        } else {
            const cropAmount = (scaledH - containerH) / scale;
            sourceY = cropAmount / 2;
            sourceH = vh - cropAmount;
        }

        canvas.width = 420;
        canvas.height = 320;
        ctx.drawImage(video, sourceX, sourceY, sourceW, sourceH, 0, 0, 420, 320);
        const dataUrl = canvas.toDataURL('image/jpeg', 0.9);

        inputs[captureStep].value = dataUrl;
        previews[captureStep].src = dataUrl;
        previews[captureStep].style.display = 'block';
        ticks[captureStep].style.display = 'block';

        captureStep++;
        updateUIForStep();
    }

    function retakeAll() {
        captureStep = 0;
        [0, 1, 2].forEach(i => {
            inputs[i].value = '';
            previews[i].style.display = 'none';
            previews[i].src = '';
            ticks[i].style.display = 'none';
        });
        startCamera();
        updateUIForStep();
    }

    // Event Listeners
    actionBtn.addEventListener('click', startCamera);
    captureBtn.addEventListener('click', capture);
    retakeBtn.addEventListener('click', retakeAll);

    // Form Submit Validation
    document.querySelector('form').addEventListener('submit', function (e) {
        // If capture has started (step > 0) but not finished (step < 3), prevent submit
        if (captureStep > 0 && captureStep < 3) {
            e.preventDefault();
            alert("Please complete capturing all 3 angles (Center, Left, Right) or refresh to cancel photo update.");
            return;
        }
        // If step is 0 (no new photos) or 3 (all new photos), allow submit.

        // Disable button to prevent double submit
        const btn = this.querySelector('button[type="submit"]');
        if (btn) {
            btn.disabled = true;
            btn.textContent = 'Updating...';
        }
    });

</script>
{% endblock %}