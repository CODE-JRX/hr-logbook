{% extends 'base.html' %}
{% block title %}Add Client â€” HRMO Logbook{% endblock %}

{% block content %}
<div class="card shadow-sm mx-auto" style="max-width:760px;">
  {% block head_extra %}
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <style>
    #previewBox {
      padding: .5rem;
      background: #f8fafc;
    }
    /* Mirror the camera feed horizontally */
    #video {
      transform: scaleX(-1);
    }
    @media (max-width: 767px) {
      #canvas {
        transform: scaleX(-1);
      }
    }
  </style>
  {% endblock %}
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0"><i class="fas fa-user-plus"></i> Registration Form</h5>
    <small class="text-muted">All fields marked <span class="text-danger">*</span> are required</small>
  </div>

  <div class="card-body">




    <form method="post" novalidate id="addClientForm">
      <div class="row g-3">
        <div class="col-12">
          <label for="full_name" class="form-label"><i class="fas fa-user"></i> Full name <span
              class="text-danger">*</span></label>
          <input class="form-control" type="text" name="full_name" id="full_name" required aria-required="true"
            placeholder="e.g. JUAN T. DELA CRUZ JR.">
        </div>

        <div class="col-md-6">
          <label for="client_type" class="form-label"><i class="fas fa-tags"></i> Client Type <span
              class="text-danger">*</span></label>
          <select class="form-select" name="client_type" id="client_type" required>
            <option value="">SELECT</option>
            <option value="EMPLOYEE">EMPLOYEE</option>
            <option value="STUDENT">STUDENT</option>
            <option value="APPLICANT">APPLICANT</option>
            <option value="VISITOR">VISITOR</option>
            <option value="OTHER">OTHER</option>
          </select>
        </div>

        <div class="col-md-6">
          <label for="gender" class="form-label"><i class="fas fa-venus-mars"></i> Gender <span
              class="text-danger">*</span></label>
          <select class="form-select" name="gender" id="gender" required>
            <option value="">SELECT</option>
            <option value="MALE">MALE</option>
            <option value="FEMALE">FEMALE</option>
            <option value="OTHER">OTHER</option>
            <option value="PREFER_NOT_TO_SAY">PREFER NOT TO SAY</option>
          </select>
        </div>

        <div class="col-md-6">
          <label for="age" class="form-label"><i class="fas fa-birthday-cake"></i> Age <span
              class="text-danger">*</span></label>
          <input class="form-control" type="number" name="age" id="age" min="0" max="150" placeholder="e.g.  35">
        </div>

        <div class="col-md-6">
          <label for="department" class="form-label"><i class="fas fa-building"></i> Department(Optional)</label>
          <input class="form-control" type="text" name="department" id="department" placeholder="e.g. HRMO">
        </div>

        <div class="col-12">
          <label class="form-label"><i class="fas fa-camera"></i> Photos (Center, Left, Right) <span
              class="text-danger">*</span></label>
          <div class="row g-2">
            <!-- Main Camera Area -->
            <div class="col-md-7">
              <div class="camera-card mx-auto shadow-sm rounded" id="cameraCanvas">
                <!-- video preview (fills card) -->
                <video id="video" width="420" height="420" autoplay playsinline muted
                  style="object-fit:cover; width:420px; height:420px; border-radius:6px; display:none;"></video>

                <!-- face position guide (subtle broken square corners) -->
                <div id="face-guide" aria-hidden="true">
                  <div class="fg-corner top-left"></div>
                  <div class="fg-corner top-right"></div>
                  <div class="fg-corner bottom-right"></div>
                  <div class="fg-corner bottom-left"></div>
                </div>

                <!-- placeholder when camera not active -->
                <div id="camera-placeholder" class="text-center text-muted" style="color:#9aa6bc">
                  <div style="font-size:44px; opacity:0.5">ðŸ“·</div>
                  <div style="margin-top:8px;">Camera Preview</div>
                </div>

                <!-- captured preview overlay -->
                <canvas id="canvas" width="420" height="420"
                  style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; border-radius:6px;"></canvas>
                <img id="preview" src="" alt="Preview"
                  style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; object-fit:contain; border-radius:6px; background:#0f1720;" />

                <div id="scan-line" style="animation: scan 2s linear;"></div>

                <!-- camera action button placed inside the camera container -->
                <button id="camera-action" type="button" title="Start camera for registration" class="btn btn-lg"
                  style="position:absolute; bottom:12px; left:50%; transform:translateX(-50%); z-index:10; min-width:140px; background:rgba(0,0,0,0.7); color:white; border:none; border-radius:6px; padding:8px 16px;">
                  <i class="fas fa-play me-2"></i>Start Camera
                </button>
              </div>

              <div class="mt-3 text-center">
                <div id="capture-controls" class="d-inline-block" style="display:none !important;">
                  <button id="capture-btn" type="button" class="btn btn-outline-primary" disabled><i
                      class="fas fa-camera"></i>
                    Capture <span id="capture-target">Center</span></button>
                  <button id="retake-btn" type="button" class="btn btn-outline-secondary ms-2" style="display:none;"><i
                      class="fas fa-redo"></i> Retake All</button>
                </div>
              </div>
              <div class="mt-2 text-center">
                <small class="text-muted" id="instruction-text">Please capture 3 angles: Center, Left Side, Right
                  Side.</small>
              </div>
            </div>

            <!-- Thumbnails Area -->
            <div class="col-md-5">
              <div class="d-flex flex-column gap-2">
                <!-- Center Preview -->
                <div class="border rounded p-1 position-relative"
                  style="background:#f8fafc; height: 100px; display: flex; align-items: center; justify-content: center;">
                  <img id="preview-center" style="max-height: 100%; max-width: 100%; display: none;" />
                  <span class="text-muted small position-absolute" id="label-center" style="opacity: 0.5;">Center
                    View</span>
                  <div class="position-absolute top-0 end-0 p-1" id="tick-center" style="display:none;"><i
                      class="fas fa-check-circle text-success"></i></div>
                </div>
                <!-- Left Preview -->
                <div class="border rounded p-1 position-relative"
                  style="background:#f8fafc; height: 100px; display: flex; align-items: center; justify-content: center;">
                  <img id="preview-left" style="max-height: 100%; max-width: 100%; display: none;" />
                  <span class="text-muted small position-absolute" id="label-left" style="opacity: 0.5;">Left Side
                    View</span>
                  <div class="position-absolute top-0 end-0 p-1" id="tick-left" style="display:none;"><i
                      class="fas fa-check-circle text-success"></i></div>
                </div>
                <!-- Right Preview -->
                <div class="border rounded p-1 position-relative"
                  style="background:#f8fafc; height: 100px; display: flex; align-items: center; justify-content: center;">
                  <img id="preview-right" style="max-height: 100%; max-width: 100%; display: none;" />
                  <span class="text-muted small position-absolute" id="label-right" style="opacity: 0.5;">Right Side
                    View</span>
                  <div class="position-absolute top-0 end-0 p-1" id="tick-right" style="display:none;"><i
                      class="fas fa-check-circle text-success"></i></div>
                </div>
              </div>

              <div id="message-overlay" class="message-overlay mt-2 position-relative" style="display:none;"></div>

              <div class="mt-3">
                <button id="saveBtn" type="submit" class="btn btn-outline-primary w-100" disabled><i
                    class="fas fa-save"></i>
                  Save Client</button>
                <button id="cancelBtn" type="button" class="btn btn-outline-secondary w-100 mt-2"><i
                    class="fas fa-times"></i>
                  Cancel</button>
              </div>
            </div>
          </div>
        </div>

      </div>
      <!-- Hidden inputs for 3 angles -->
      <input type="hidden" name="photo_data_center" id="photo_data_center">
      <input type="hidden" name="photo_data_left" id="photo_data_left">
      <input type="hidden" name="photo_data_right" id="photo_data_right">
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const preview = document.getElementById('preview');
  const scanLine = document.getElementById('scan-line');
  const placeholder = document.getElementById('camera-placeholder');
  const actionBtn = document.getElementById('camera-action');
  const captureControls = document.getElementById('capture-controls');
  const captureBtn = document.getElementById('capture-btn');
  const retakeBtn = document.getElementById('retake-btn');
  const captureTarget = document.getElementById('capture-target');
  const instructionText = document.getElementById('instruction-text');

  const saveBtn = document.getElementById('saveBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const messageOverlay = document.getElementById('message-overlay');
  const cameraCanvas = document.getElementById('cameraCanvas');

  // Input fields
  const inputs = {
    0: document.getElementById('photo_data_center'),
    1: document.getElementById('photo_data_left'),
    2: document.getElementById('photo_data_right')
  };

  // Preview elements
  const previews = {
    0: document.getElementById('preview-center'),
    1: document.getElementById('preview-left'),
    2: document.getElementById('preview-right')
  };

  const ticks = {
    0: document.getElementById('tick-center'),
    1: document.getElementById('tick-left'),
    2: document.getElementById('tick-right')
  };

  let stream = null;
  let cameraState = 'stopped'; // 'stopped' | 'started'
  let captureStep = 0; // 0=Center, 1=Left, 2=Right, 3=Done

  // Function to show message overlay
  function showMessage(message, type) {
    if (!messageOverlay) return;
    messageOverlay.textContent = message;
    messageOverlay.className = `message-overlay ${type}`;
    messageOverlay.style.display = 'block';
    setTimeout(() => {
      messageOverlay.style.display = 'none';
    }, 4000);
  }

  async function startCamera() {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } });
      video.srcObject = stream;
      video.style.display = 'block';
      placeholder.style.display = 'none';
      preview.style.display = 'none';

      // Update action button for integrated UI
      actionBtn.innerHTML = '<i class="fas fa-stop me-2"></i>Stop Camera';
      actionBtn.style.background = 'rgba(220, 53, 69, 0.7)'; // Reddish for stop

      captureControls.style.display = 'inline-block';
      captureControls.style.setProperty('display', 'inline-block', 'important');

      captureBtn.disabled = false;
      cameraState = 'started';
      updateUIForStep();
    } catch (err) {
      alert('Camera error: ' + err.message);
    }
  }

  function stopCamera() {
    if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
    video.srcObject = null;
    video.style.display = 'none';
    placeholder.style.display = 'block';
    preview.style.display = 'none';

    actionBtn.innerHTML = '<i class="fas fa-play me-2"></i>Start Camera';
    actionBtn.style.background = 'rgba(0,0,0,0.7)';

    // Only hide controls if capture is not finished (to allow Retake All)
    if (captureStep !== 3) {
      captureControls.style.display = 'none';
    }
    cameraState = 'stopped';
  }

  function toggleCamera() {
    if (cameraState === 'stopped') {
      startCamera();
    } else {
      stopCamera();
    }
  }

  function updateUIForStep() {
    if (captureStep === 0) {
      captureTarget.textContent = "Center";
      instructionText.textContent = "Please look at the camera (Center).";
      captureBtn.disabled = false;
      captureBtn.style.display = 'inline-block';
      retakeBtn.style.display = 'none';
    } else if (captureStep === 1) {
      captureTarget.textContent = "Left Side";
      instructionText.textContent = "Please turn slightly to show your LEFT side.";
    } else if (captureStep === 2) {
      captureTarget.textContent = "Right Side";
      instructionText.textContent = "Please turn slightly to show your RIGHT side.";
    } else if (captureStep === 3) {
      captureBtn.style.display = 'none';
      retakeBtn.style.display = 'inline-block';
      instructionText.textContent = "All angles captured. You can now save.";
      stopCamera(); // Auto-stop camera when done
      validateForm();
    }
  }

  function capture() {
    if (captureStep > 2) return;

    const ctx = canvas.getContext('2d');
    const containerW = 420;
    const containerH = 420; // Match camera-card 1:1 if possible, but custom.css says 4/3
    const vw = video.videoWidth || 420;
    const vh = video.videoHeight || 420;
    const scale = Math.max(containerW / vw, containerH / vh);
    const scaledW = vw * scale;
    const scaledH = vh * scale;
    let sourceX = 0, sourceY = 0, sourceW = vw, sourceH = vh;

    if (scaledW > containerW) {
      const cropAmount = (scaledW - containerW) / scale;
      sourceX = cropAmount / 2;
      sourceW = vw - cropAmount;
    } else {
      const cropAmount = (scaledH - containerH) / scale;
      sourceY = cropAmount / 2;
      sourceH = vh - cropAmount;
    }

    canvas.width = 420;
    canvas.height = 420;
    ctx.save();
    ctx.translate(420, 0);
    ctx.scale(-1, 1);
    ctx.drawImage(video, sourceX, sourceY, sourceW, sourceH, 0, 0, 420, 420);
    ctx.restore();
    const dataUrl = canvas.toDataURL('image/jpeg', 0.9);

    // Show scan animation
    scanLine.style.display = 'block';
    scanLine.style.animation = 'none';
    setTimeout(() => { scanLine.style.animation = 'scan 2s linear'; }, 10);

    // Briefly show the captured photo in the main frame then hide it as we move to next step
    preview.src = dataUrl;
    preview.style.display = 'block';
    setTimeout(() => {
      if (cameraState === 'started') {
        preview.style.display = 'none';
        scanLine.style.display = 'none';
      }
    }, 1500);

    // Save to hidden input and update thumb preview
    inputs[captureStep].value = dataUrl;
    previews[captureStep].src = dataUrl;
    previews[captureStep].style.display = 'block';
    ticks[captureStep].style.display = 'block';

    captureStep++;
    updateUIForStep();
    validateForm();
  }

  function retakeAll() {
    captureStep = 0;

    // Clear inputs and previews
    [0, 1, 2].forEach(i => {
      inputs[i].value = '';
      previews[i].style.display = 'none';
      previews[i].src = '';
      ticks[i].style.display = 'none';
    });

    startCamera();
    validateForm();
  }

  // Event Listeners
  actionBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    toggleCamera();
  });

  if (cameraCanvas) {
    cameraCanvas.addEventListener('click', () => {
      if (cameraState === 'stopped') {
        startCamera();
      } else if (cameraState === 'started') {
        capture();
      }
    });
  }

  captureBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    capture();
  });

  retakeBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    retakeAll();
  });

  cancelBtn.addEventListener('click', () => {
    document.getElementById('addClientForm').reset();
    stopCamera();
    retakeAll(); // Reset steps
    captureStep = 0;
    updateUIForStep();
  });

  // Validation
  function validateForm() {
    const name = document.getElementById('full_name').value.trim();
    const clientType = document.getElementById('client_type').value;
    const gender = document.getElementById('gender').value;
    const age = document.getElementById('age').value.trim();

    // Check if all 3 photos are present
    const allPhotos = inputs[0].value && inputs[1].value && inputs[2].value;

    saveBtn.disabled = !(name && clientType && gender && age && allPhotos);
  }

  ['full_name', 'age'].forEach(id => document.getElementById(id).addEventListener('input', validateForm));
  ['client_type', 'gender'].forEach(id => document.getElementById(id).addEventListener('change', validateForm));

  document.getElementById('addClientForm').addEventListener('submit', (e) => {
    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';
  });
</script>
{% endblock %}