{% extends 'base.html' %}
{% block title %}Admin Dashboard â€” HR Logbook{% endblock %}

{% block head_extra %}
<style>.card { margin-bottom: 1rem }</style>
{% endblock %}

{% block content %}
  <div class="container-fluid mt-2">
    <div class="card shadow-sm p-3">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Admin Dashboard</h3>
        <div>
          <a class="btn btn-outline-secondary btn-sm" href="/admin/logout">Logout</a>
        </div>
      </div>

      <div class="row">
        <div class="col-md-3">
          <div class="card shadow-sm p-3">
            <h6><i class="fas fa-users"></i> Total Registered Clients</h6>
            <h2>{{ stats.total_employees }}</h2>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card shadow-sm p-3">
            <h6><i class="fas fa-clipboard-list"></i> Total Logs</h6>
            <h2>{{ stats.total_logs }}</h2>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card shadow-sm p-3">
            <h6><i class="fas fa-chart-line"></i> Recent Activity (last 14 days)</h6>
            <canvas id="chartActivity" height="80"></canvas>
          </div>
        </div>
      </div>

      <div class="row mt-3">
        <div class="col-md-12">
          <div class="card shadow-sm p-3">
            <h6><i class="fas fa-chart-bar"></i> Purpose Counts</h6>
            <canvas id="chartPurpose" height="200"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <!-- Load Chart.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
  async function loadChartData(days=14){
    const res = await fetch('/admin/chart_data?days=' + days);
    const data = await res.json();
    return data;
  }

  function buildLineChart(ctx, labels, data){
    return new Chart(ctx, {
      type: 'line',
      data: { labels, datasets: [{ label: 'Entries', data, fill:false, borderColor:'#0d6efd', tension:0.2 }]},
      options: { responsive:true }
    });
  }



  function buildBarChart(ctx, labels, data){
    return new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label:'Count', data, backgroundColor:'#198754' }]},
      options: { responsive:true }
    });
  }

  // Wait for Chart.js to load before building charts
  function waitForChartJS(callback) {
    if (typeof Chart !== 'undefined') {
      callback();
    } else {
      setTimeout(() => waitForChartJS(callback), 100);
    }
  }

  waitForChartJS(async () => {
    const d = await loadChartData(14);
    // by_day -> list of {day, cnt}
    const days = d.by_day.map(r=> r.day);
    const dayCounts = d.by_day.map(r=>r.cnt);
    const ctxA = document.getElementById('chartActivity').getContext('2d');
    buildLineChart(ctxA, days, dayCounts);



    const pLabels = d.purpose.map(r=>r.purpose);
    const pCounts = d.purpose.map(r=>r.cnt);
    const ctxP = document.getElementById('chartPurpose').getContext('2d');
    buildBarChart(ctxP, pLabels, pCounts);
  });
  </script>
{% endblock %}
