{% extends 'base.html' %}
{% block title %}Admin Signup â€” HR Logbook{% endblock %}

{% block head_extra %}
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<style>
	.preview-frame {
		padding: .5rem;
		background: #f8fafc;
	}
	 #video {
        transform: scaleX(-1);
    }
    @media (max-width: 767px) {
        #canvas {
            transform: scaleX(-1);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="card shadow-sm mx-auto" style="max-width:760px;">
	<div class="card-header d-flex justify-content-between align-items-center">
		<h5 class="mb-0"><i class="fas fa-user-shield"></i> Create Admin Account</h5>
		<small class="text-muted">All fields marked <span class="text-danger">*</span> are required</small>
	</div>
	<div class="card-body">

		{% if error %}
		<div class="alert alert-danger">{{ error }}</div>
		{% endif %}

		{% if success %}
		<div class="alert alert-success">{{ success }}</div>
		{% endif %}

		<form method="post" action="/admin/signup" novalidate id="adminSignupForm">
			<div class="row g-3">
				<div class="col-12 col-md-6">
					<label for="first_name" class="form-label"><i class="fas fa-user"></i> First name <span
							class="text-danger">*</span></label>
					<input type="text" class="form-control" id="first_name" name="first_name" required>
				</div>
				<div class="col-12 col-md-6">
					<label for="last_name" class="form-label"><i class="fas fa-user"></i> Last name <span
							class="text-danger">*</span></label>
					<input type="text" class="form-control" id="last_name" name="last_name" required>
				</div>

				<div class="col-12">
					<label for="email" class="form-label"><i class="fas fa-envelope"></i> Email <span
							class="text-danger">*</span></label>
					<input type="email" class="form-control" id="email" name="email" required
						oninput="this.value = this.value.toLowerCase()" style="text-transform: lowercase;">
				</div>

				<div class="col-12 col-md-6">
					<label for="password" class="form-label"><i class="fas fa-lock"></i> Password <span
							class="text-danger">*</span></label>
					<input type="password" class="form-control" id="password" name="password" required>
				</div>

				<div class="col-12 col-md-6">
					<label for="confirm_password" class="form-label"><i class="fas fa-lock"></i> Confirm Password <span
							class="text-danger">*</span></label>
					<input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
				</div>

				<div class="col-12 col-md-6">
					<label for="pin" class="form-label"><i class="fas fa-key"></i> 4-Digit PIN (for Face Login) <span
							class="text-danger">*</span></label>
					<input type="password" class="form-control" id="pin" name="pin" maxlength="4" pattern="[0-9]{4}"
						inputmode="numeric" required placeholder="####">
					<div class="form-text">Used for 2FA during face login.</div>
				</div>

				<div class="col-12">
					<label class="form-label"><i class="fas fa-camera"></i> Photo Registration (3 Angles) <span
							class="text-danger">*</span></label>
					<div class="row g-2">
						<div class="col-md-7">
							<div class="camera-card mx-auto shadow-sm rounded" id="cameraCanvas">
								<!-- video preview (fills card) -->
								<video id="video" width="420" height="420" autoplay playsinline muted
									style="object-fit:cover; width:420px; height:420px; border-radius:6px; display:none;"></video>

								<!-- face position guide (subtle broken square corners) -->
								<div id="face-guide" aria-hidden="true">
									<div class="fg-corner top-left"></div>
									<div class="fg-corner top-right"></div>
									<div class="fg-corner bottom-right"></div>
									<div class="fg-corner bottom-left"></div>
								</div>

								<!-- placeholder when camera not active -->
								<div id="camera-placeholder" class="text-center text-muted" style="color:#9aa6bc">
									<div style="font-size:44px; opacity:0.5">ðŸ“·</div>
									<div style="margin-top:8px;">Camera Preview</div>
								</div>

								<!-- captured preview overlay -->
								<canvas id="canvas" width="420" height="420"
									style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; border-radius:6px;"></canvas>
								<img id="preview" src="" alt="Preview"
									style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; object-fit:contain; border-radius:6px; background:#0f1720;" />

								<div id="scan-line" style="animation: scan 2s linear;"></div>

								<!-- camera action button placed inside the camera container -->
								<button id="camera-action" type="button" title="Start camera for registration"
									class="btn btn-lg"
									style="position:absolute; bottom:12px; left:50%; transform:translateX(-50%); z-index:10; min-width:140px; background:rgba(0,0,0,0.7); color:white; border:none; border-radius:6px; padding:8px 16px;">
									<i class="fas fa-play me-2"></i>Start Camera
								</button>
							</div>

							<div class="mt-3 text-center">
								<div id="capture-controls" style="display:none;">
									<p id="instruction-text" class="mb-2 fw-bold text-primary">Please look at the camera
										(Center).</p>
									<button id="capture-btn" type="button" class="btn btn-outline-primary" disabled><i
											class="fas fa-camera"></i> Capture <span
											id="capture-target">Center</span></button>
									<button id="retake-btn" type="button" class="btn btn-outline-secondary ms-2"
										style="display:none;"><i class="fas fa-redo"></i> Retake All</button>
								</div>
							</div>
						</div>

						<div class="col-md-5">
							<div class="d-flex flex-column gap-2">
								<!-- Preview: Center angle -->
								<div class="border rounded p-1 position-relative"
									style="background:#f8fafc; height: 100px; display: flex; align-items: center; justify-content: center;"
									id="previewBox-center">
									<img id="preview-center" style="max-height: 100%; max-width: 100%; display: none;">
									<span class="text-muted small position-absolute" id="placeholder-center"
										style="opacity: 0.5;">Center View</span>
									<div class="position-absolute top-0 end-0 p-1" id="tick-center"
										style="display:none;"><i class="fas fa-check-circle text-success"></i>
									</div>
								</div>

								<!-- Preview: Left angle -->
								<div class="border rounded p-1 position-relative"
									style="background:#f8fafc; height: 100px; display: flex; align-items: center; justify-content: center;"
									id="previewBox-left">
									<img id="preview-left" style="max-height: 100%; max-width: 100%; display: none;">
									<span class="text-muted small position-absolute" id="placeholder-left"
										style="opacity: 0.5;">Left Side View</span>
									<div class="position-absolute top-0 end-0 p-1" id="tick-left" style="display:none;">
										<i class="fas fa-check-circle text-success"></i>
									</div>
								</div>

								<!-- Preview: Right angle -->
								<div class="border rounded p-1 position-relative"
									style="background:#f8fafc; height: 100px; display: flex; align-items: center; justify-content: center;"
									id="previewBox-right">
									<img id="preview-right" style="max-height: 100%; max-width: 100%; display: none;">
									<span class="text-muted small position-absolute" id="placeholder-right"
										style="opacity: 0.5;">Right Side View</span>
									<div class="position-absolute top-0 end-0 p-1" id="tick-right"
										style="display:none;"><i class="fas fa-check-circle text-success"></i>
									</div>
								</div>
							</div>

							<div id="message-overlay" class="message-overlay mt-2 position-relative"
								style="display:none;"></div>

							<div class="mt-3">
								<button id="signupBtn" type="submit" class="btn btn-outline-primary w-100" disabled><i
										class="fas fa-user-plus"></i> Create account</button>
								<a href="/admin/login" class="btn btn-outline-secondary w-100 mt-2"><i
										class="fas fa-sign-in-alt"></i> Sign in</a>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Hidden inputs for 3 angles -->
			<input type="hidden" name="photo_data_center" id="photo_data_center">
			<input type="hidden" name="photo_data_left" id="photo_data_left">
			<input type="hidden" name="photo_data_right" id="photo_data_right">
		</form>
	</div>
</div>
{% endblock %}

{% block scripts %}
<script>
	const video = document.getElementById('video');
	const canvas = document.getElementById('canvas');
	const preview = document.getElementById('preview');
	const scanLine = document.getElementById('scan-line');
	const placeholder = document.getElementById('camera-placeholder');
	const actionBtn = document.getElementById('camera-action');
	const cameraCanvas = document.getElementById('cameraCanvas');

	const captureControls = document.getElementById('capture-controls');
	const captureBtn = document.getElementById('capture-btn');
	const retakeBtn = document.getElementById('retake-btn');
	const captureTarget = document.getElementById('capture-target');
	const instructionText = document.getElementById('instruction-text');

	const signupBtn = document.getElementById('signupBtn');
	const messageOverlay = document.getElementById('message-overlay');

	// Input fields
	const inputs = {
		0: document.getElementById('photo_data_center'),
		1: document.getElementById('photo_data_left'),
		2: document.getElementById('photo_data_right')
	};

	// Preview elements
	const previews = {
		0: document.getElementById('preview-center'),
		1: document.getElementById('preview-left'),
		2: document.getElementById('preview-right')
	};

	const ticks = {
		0: document.getElementById('tick-center'),
		1: document.getElementById('tick-left'),
		2: document.getElementById('tick-right')
	};

	// Placeholder elements for each preview box
	const placeholders = {
		0: document.getElementById('placeholder-center'),
		1: document.getElementById('placeholder-left'),
		2: document.getElementById('placeholder-right')
	};

	let stream = null;
	let cameraState = 'stopped'; // 'stopped' | 'started'
	let captureStep = 0; // 0=Center, 1=Left, 2=Right, 3=Done

	function showMessage(message, type) {
		messageOverlay.textContent = message;
		messageOverlay.className = `message-overlay ${type}`;
		messageOverlay.style.display = 'block';
		setTimeout(() => {
			messageOverlay.style.display = 'none';
		}, 4000);
	}

	async function startCamera() {
		try {
			stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } });
			video.srcObject = stream;
			video.style.display = 'block';
			placeholder.style.display = 'none';
			preview.style.display = 'none';

			// Update action button for integrated UI
			actionBtn.innerHTML = '<i class="fas fa-stop me-2"></i>Stop Camera';
			actionBtn.style.background = 'rgba(220, 53, 69, 0.7)'; // Reddish for stop

			captureControls.style.display = 'block';
			captureBtn.disabled = false;
			cameraState = 'started';
			updateUIForStep();
		} catch (err) {
			alert('Camera error: ' + err.message);
		}
	}

	function stopCamera() {
		if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
		video.srcObject = null;
		video.style.display = 'none';
		placeholder.style.display = 'block';
		preview.style.display = 'none';

		actionBtn.innerHTML = '<i class="fas fa-play me-2"></i>Start Camera';
		actionBtn.style.background = 'rgba(0,0,0,0.7)';

		// Only hide controls if capture is not finished (to allow Retake All)
		if (captureStep !== 3) {
			captureControls.style.display = 'none';
		}
		cameraState = 'stopped';
	}

	function toggleCamera() {
		if (cameraState === 'stopped') {
			startCamera();
		} else {
			stopCamera();
		}
	}

	function updateUIForStep() {
		if (captureStep === 0) {
			captureTarget.textContent = "Center";
			instructionText.textContent = "Please look at the camera (Center).";
			captureBtn.disabled = false;
			captureBtn.style.display = 'inline-block';
			retakeBtn.style.display = 'none';
		} else if (captureStep === 1) {
			captureTarget.textContent = "Left Side";
			instructionText.textContent = "Please turn slightly to show your LEFT side.";
		} else if (captureStep === 2) {
			captureTarget.textContent = "Right Side";
			instructionText.textContent = "Please turn slightly to show your RIGHT side.";
		} else if (captureStep === 3) {
			captureBtn.style.display = 'none';
			retakeBtn.style.display = 'inline-block';
			instructionText.textContent = "All angles captured. You can now signup.";
			stopCamera();
			validateForm();
		}
	}

	function capture() {
		if (captureStep > 2) return;

		const ctx = canvas.getContext('2d');
		// Calculate visible area logic...
		const containerW = 420;
		const containerH = 420;
		const vw = video.videoWidth || 420;
		const vh = video.videoHeight || 420;
		const scale = Math.max(containerW / vw, containerH / vh);
		const scaledW = vw * scale;
		const scaledH = vh * scale;
		let sourceX = 0, sourceY = 0, sourceW = vw, sourceH = vh;

		if (scaledW > containerW) {
			const cropAmount = (scaledW - containerW) / scale;
			sourceX = cropAmount / 2;
			sourceW = vw - cropAmount;
		} else {
			const cropAmount = (scaledH - containerH) / scale;
			sourceY = cropAmount / 2;
			sourceH = vh - cropAmount;
		}

		canvas.width = 420;
		canvas.height = 420;
		ctx.save();
		ctx.translate(420, 0);
		ctx.scale(-1, 1);
		ctx.drawImage(video, sourceX, sourceY, sourceW, sourceH, 0, 0, 420, 420);
		ctx.restore();
		const dataUrl = canvas.toDataURL('image/jpeg', 0.9);

		// Show scan animation
		scanLine.style.display = 'block';
		scanLine.style.animation = 'none';
		setTimeout(() => { scanLine.style.animation = 'scan 2s linear'; }, 10);

		// Briefly show the captured photo in the main frame then hide it as we move to next step
		preview.src = dataUrl;
		preview.style.display = 'block';
		setTimeout(() => {
			if (cameraState === 'started') {
				preview.style.display = 'none';
				scanLine.style.display = 'none';
			}
		}, 1500);

		// Save to hidden input and update thumb preview
		inputs[captureStep].value = dataUrl;
		previews[captureStep].src = dataUrl;
		previews[captureStep].style.display = 'block';
		ticks[captureStep].style.display = 'block';
		// Hide the placeholder text
		if (placeholders[captureStep]) {
			placeholders[captureStep].style.display = 'none';
		}

		captureStep++;
		updateUIForStep();
		validateForm();
	}

	function retakeAll() {
		captureStep = 0;

		// Clear inputs and previews
		[0, 1, 2].forEach(i => {
			inputs[i].value = '';
			previews[i].style.display = 'none';
			previews[i].src = '';
			ticks[i].style.display = 'none';
			// Restore placeholder text
			if (placeholders[i]) {
				placeholders[i].style.display = '';
			}
		});

		startCamera();
		validateForm();
	}

	// Event Listeners
	actionBtn.addEventListener('click', (e) => {
		e.stopPropagation();
		toggleCamera();
	});

	if (cameraCanvas) {
		cameraCanvas.addEventListener('click', () => {
			if (cameraState === 'stopped') {
				startCamera();
			} else if (cameraState === 'started') {
				capture();
			}
		});
	}

	captureBtn.addEventListener('click', (e) => {
		e.stopPropagation();
		capture();
	});

	retakeBtn.addEventListener('click', (e) => {
		e.stopPropagation();
		retakeAll();
	});

	// Basic client-side validation
	function validateForm() {
		const firstName = document.getElementById('first_name').value.trim();
		const lastName = document.getElementById('last_name').value.trim();
		const email = document.getElementById('email').value.trim();
		const password = document.getElementById('password').value.trim();
		const confirmPassword = document.getElementById('confirm_password').value.trim();
		const pin = document.getElementById('pin').value.trim();

		const allPhotos = inputs[0].value && inputs[1].value && inputs[2].value;
		const passwordsMatch = password === confirmPassword;
		const pinValid = /^\d{4}$/.test(pin);

		signupBtn.disabled = !(firstName && lastName && email && password && confirmPassword && passwordsMatch && allPhotos && pinValid);
	}

	['first_name', 'last_name', 'email', 'password', 'confirm_password', 'pin'].forEach(id => document.getElementById(id).addEventListener('input', validateForm));

	// on submit, disable signup button to prevent double submit
	document.getElementById('adminSignupForm').addEventListener('submit', (e) => {
		signupBtn.disabled = true;
		signupBtn.textContent = 'Creating account...';
	});
</script>
{% endblock %}