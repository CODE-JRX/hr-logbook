{% extends 'base.html' %}
{% block title %}Admin Signup â€” HR Logbook{% endblock %}

{% block head_extra %}
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<style>
	.media-frame {
		width: 100%;
		aspect-ratio: 4 / 3;
		/* modern browsers */
		max-height: 420px;
		background: #0f1720;
		border-radius: 8px;
		border: 3px solid rgba(13, 110, 253, 0.08);
		display: flex;
		align-items: center;
		justify-content: center;
		position: relative;
		overflow: hidden;
	}

	.media-frame video {
		width: 100%;
		height: 100%;
		object-fit: cover;
		display: block;
	}

	/* Make preview match live preview â€” use cover so framing matches */
	.media-frame img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		display: block;
	}

	/* Camera guide: subtle broken square shown over the live preview */
	#face-guide {
		position: absolute;
		top: 50%;
		left: 50%;
		transform: translate(-50%, -50%);
		width: 60%;
		height: 60%;
		pointer-events: none;
		z-index: 6;
	}

	#face-guide .fg-corner {
		position: absolute;
		width: clamp(32px, 8%, 56px);
		height: clamp(32px, 8%, 56px);
		box-sizing: border-box;
		border-radius: 4px;
		border-color: rgba(154, 166, 188, 0.28);
		border-style: solid;
	}

	#face-guide .top-left {
		top: 0;
		left: 0;
		border-right: none;
		border-bottom: none;
	}

	#face-guide .top-right {
		top: 0;
		right: 0;
		border-left: none;
		border-bottom: none;
	}

	#face-guide .bottom-right {
		bottom: 0;
		right: 0;
		border-left: none;
		border-top: none;
	}

	#face-guide .bottom-left {
		bottom: 0;
		left: 0;
		border-right: none;
		border-top: none;
	}

	.preview-frame {
		padding: .5rem;
		background: #f8fafc;
	}

	.message-overlay {
		position: absolute;
		top: 10px;
		left: 10px;
		right: 10px;
		padding: 6px 10px;
		border-radius: 6px;
		color: white;
		font-weight: bold;
		text-align: center;
		z-index: 10;
		display: none;
		font-size: 12px;
		line-height: 1.2;
		word-wrap: break-word;
	}

	.message-overlay.success {
		background-color: rgba(25, 135, 84, 1);
	}

	.message-overlay.error {
		background-color: rgba(220, 53, 69, 1);
	}
</style>
{% endblock %}

{% block content %}
<div class="card shadow-sm mx-auto" style="max-width:760px;">
	<div class="card-body">
		<h4 class="card-title mb-3">Create Admin Account</h4>

		{% if error %}
		<div class="alert alert-danger">{{ error }}</div>
		{% endif %}

		{% if success %}
		<div class="alert alert-success">{{ success }}</div>
		{% endif %}

		<form method="post" action="/admin/signup" novalidate id="adminSignupForm">
			<div class="row g-3">
				<div class="col-12 col-md-6">
					<label for="first_name" class="form-label">First name <span class="text-danger">*</span></label>
					<input type="text" class="form-control" id="first_name" name="first_name" required>
				</div>
				<div class="col-12 col-md-6">
					<label for="last_name" class="form-label">Last name <span class="text-danger">*</span></label>
					<input type="text" class="form-control" id="last_name" name="last_name" required>
				</div>

				<div class="col-12">
					<label for="email" class="form-label">Email <span class="text-danger">*</span></label>
					<input type="email" class="form-control" id="email" name="email" required>
				</div>

				<div class="col-12 col-md-6">
					<label for="password" class="form-label">Password <span class="text-danger">*</span></label>
					<input type="password" class="form-control" id="password" name="password" required>
				</div>

				<div class="col-12 col-md-6">
					<label for="confirm_password" class="form-label">Confirm Password <span
							class="text-danger">*</span></label>
					<input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
				</div>

				<div class="col-12 col-md-6">
					<label for="pin" class="form-label">4-Digit PIN (for Face Login) <span
							class="text-danger">*</span></label>
					<input type="password" class="form-control" id="pin" name="pin" maxlength="4" pattern="[0-9]{4}"
						inputmode="numeric" required placeholder="####">
					<div class="form-text">Used for 2FA during face login.</div>
				</div>

				<div class="col-12">
					<label class="form-label">Photo Registration (3 Angles) <span class="text-danger">*</span></label>
					<div class="row g-2">
						<div class="col-md-7">
							<div class="mx-auto shadow-sm rounded media-frame">
								<video id="video" autoplay playsinline style="display:none; border-radius:6px;"></video>

								<!-- face position guide (subtle broken square corners) -->
								<div id="face-guide" aria-hidden="true">
									<div class="fg-corner top-left"></div>
									<div class="fg-corner top-right"></div>
									<div class="fg-corner bottom-right"></div>
									<div class="fg-corner bottom-left"></div>
								</div>
								<div id="camera-placeholder" class="text-center text-muted" style="color:#9aa6bc">
									<div style="font-size:38px; opacity:0.6">ðŸ“·</div>
									<div style="margin-top:6px;">Camera Preview</div>
								</div>
								<canvas id="canvas" width="420" height="320"
									style="display:none; position:absolute; top:0; left:0; border-radius:6px;"></canvas>
							</div>

							<div class="mt-3 text-center">
								<button id="camera-action" type="button" class="btn btn-primary me-2"><i
										class="fas fa-play"></i> Start Camera</button>

								<div id="capture-controls" style="display:none;">
									<p id="instruction-text" class="mb-2 fw-bold text-primary">Please look at the camera
										(Center).</p>
									<button id="capture-btn" type="button" class="btn btn-warning"><i
											class="fas fa-camera"></i> Capture <span
											id="capture-target">Center</span></button>
									<button id="retake-btn" type="button" class="btn btn-outline-danger"
										style="display:none;"><i class="fas fa-redo"></i> Retake All</button>
								</div>
							</div>
						</div>

						<div class="col-md-5">
							<div class="d-flex flex-column gap-2">
								<!-- Preview: Center angle -->
								<div class="border rounded p-1 position-relative"
									style="background:#f8fafc; height: 100px; display: flex; align-items: center; justify-content: center;"
									id="previewBox-center">
									<img id="preview-center" style="max-height: 100%; max-width: 100%; display: none;">
									<span class="text-muted small position-absolute" id="placeholder-center"
										style="opacity: 0.5;">Center View</span>
									<div class="position-absolute top-0 end-0 p-1" id="tick-center"
										style="display:none;"><i class="fas fa-check-circle text-success"></i>
									</div>
								</div>

								<!-- Preview: Left angle -->
								<div class="border rounded p-1 position-relative"
									style="background:#f8fafc; height: 100px; display: flex; align-items: center; justify-content: center;"
									id="previewBox-left">
									<img id="preview-left" style="max-height: 100%; max-width: 100%; display: none;">
									<span class="text-muted small position-absolute" id="placeholder-left"
										style="opacity: 0.5;">Left Side View</span>
									<div class="position-absolute top-0 end-0 p-1" id="tick-left" style="display:none;">
										<i class="fas fa-check-circle text-success"></i>
									</div>
								</div>

								<!-- Preview: Right angle -->
								<div class="border rounded p-1 position-relative"
									style="background:#f8fafc; height: 100px; display: flex; align-items: center; justify-content: center;"
									id="previewBox-right">
									<img id="preview-right" style="max-height: 100%; max-width: 100%; display: none;">
									<span class="text-muted small position-absolute" id="placeholder-right"
										style="opacity: 0.5;">Right Side View</span>
									<div class="position-absolute top-0 end-0 p-1" id="tick-right"
										style="display:none;"><i class="fas fa-check-circle text-success"></i>
									</div>
								</div>
							</div>

							<div id="message-overlay" class="message-overlay mt-2 position-relative"
								style="display:none;"></div>

							<div class="mt-3">
								<button id="signupBtn" type="submit" class="btn btn-success w-100" disabled><i
										class="fas fa-user-plus"></i> Create account</button>
								<a href="/admin/login" class="btn btn-outline-secondary w-100 mt-2"><i
										class="fas fa-sign-in-alt"></i> Sign in</a>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Hidden inputs for 3 angles -->
			<input type="hidden" name="photo_data_center" id="photo_data_center">
			<input type="hidden" name="photo_data_left" id="photo_data_left">
			<input type="hidden" name="photo_data_right" id="photo_data_right">
		</form>
	</div>
</div>
{% endblock %}

{% block scripts %}
<script>
	const video = document.getElementById('video');
	const canvas = document.getElementById('canvas');
	const placeholder = document.getElementById('camera-placeholder');
	const actionBtn = document.getElementById('camera-action');

	const captureControls = document.getElementById('capture-controls');
	const captureBtn = document.getElementById('capture-btn');
	const retakeBtn = document.getElementById('retake-btn');
	const captureTarget = document.getElementById('capture-target');
	const instructionText = document.getElementById('instruction-text');

	const signupBtn = document.getElementById('signupBtn');
	const messageOverlay = document.getElementById('message-overlay');

	// Input fields
	const inputs = {
		0: document.getElementById('photo_data_center'),
		1: document.getElementById('photo_data_left'),
		2: document.getElementById('photo_data_right')
	};

	// Preview elements
	const previews = {
		0: document.getElementById('preview-center'),
		1: document.getElementById('preview-left'),
		2: document.getElementById('preview-right')
	};

	const ticks = {
		0: document.getElementById('tick-center'),
		1: document.getElementById('tick-left'),
		2: document.getElementById('tick-right')
	};

	// Placeholder elements for each preview box
	const placeholders = {
		0: document.getElementById('placeholder-center'),
		1: document.getElementById('placeholder-left'),
		2: document.getElementById('placeholder-right')
	};

	let stream = null;
	let cameraState = 'stopped'; // 'stopped' | 'started'
	let captureStep = 0; // 0=Center, 1=Left, 2=Right, 3=Done

	function showMessage(message, type) {
		messageOverlay.textContent = message;
		messageOverlay.className = `message-overlay ${type}`;
		messageOverlay.style.display = 'block';
		setTimeout(() => {
			messageOverlay.style.display = 'none';
		}, 4000);
	}

	async function startCamera() {
		try {
			stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } });
			video.srcObject = stream;
			video.style.display = 'block';
			placeholder.style.display = 'none';
			actionBtn.style.display = 'none'; // Hide start button
			captureControls.style.display = 'inline-block'; // Show capture controls
			captureControls.style.setProperty('display', 'inline-block', 'important');

			captureBtn.disabled = false;
			cameraState = 'started';
			updateUIForStep();
		} catch (err) {
			alert('Camera error: ' + err.message);
		}
	}

	function stopCamera() {
		if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
		video.srcObject = null;
		video.style.display = 'none';
		placeholder.style.display = 'block';
		actionBtn.style.display = 'inline-block';
		actionBtn.textContent = 'Start Camera';
		captureControls.style.display = 'none';
		cameraState = 'stopped';
	}

	function updateUIForStep() {
		if (captureStep === 0) {
			captureTarget.textContent = "Center";
			instructionText.textContent = "Please look at the camera (Center).";
			captureBtn.disabled = false;
			captureBtn.style.display = 'inline-block';
			retakeBtn.style.display = 'none';
		} else if (captureStep === 1) {
			captureTarget.textContent = "Left Side";
			instructionText.textContent = "Please turn slightly to show your LEFT side.";
		} else if (captureStep === 2) {
			captureTarget.textContent = "Right Side";
			instructionText.textContent = "Please turn slightly to show your RIGHT side.";
		} else if (captureStep === 3) {
			captureBtn.style.display = 'none';
			retakeBtn.style.display = 'inline-block';
			instructionText.textContent = "All angles captured. You can now signup.";
			stopCamera(); // Auto-stop camera when done
			validateForm();
		}
	}

	function capture() {
		if (captureStep > 2) return;

		const ctx = canvas.getContext('2d');
		// Calculate visible area logic...
		const containerW = 420;
		const containerH = 320;
		const vw = video.videoWidth || 420;
		const vh = video.videoHeight || 320;
		const scale = Math.max(containerW / vw, containerH / vh);
		const scaledW = vw * scale;
		const scaledH = vh * scale;
		let sourceX = 0, sourceY = 0, sourceW = vw, sourceH = vh;

		if (scaledW > containerW) {
			const cropAmount = (scaledW - containerW) / scale;
			sourceX = cropAmount / 2;
			sourceW = vw - cropAmount;
		} else {
			const cropAmount = (scaledH - containerH) / scale;
			sourceY = cropAmount / 2;
			sourceH = vh - cropAmount;
		}

		canvas.width = 420;
		canvas.height = 320;
		ctx.drawImage(video, sourceX, sourceY, sourceW, sourceH, 0, 0, 420, 320);
		const dataUrl = canvas.toDataURL('image/jpeg', 0.9);

		// Save to input and preview
		inputs[captureStep].value = dataUrl;
		previews[captureStep].src = dataUrl;
		previews[captureStep].style.display = 'block';
		ticks[captureStep].style.display = 'block';
		// Hide the placeholder text
		if (placeholders[captureStep]) {
			placeholders[captureStep].style.display = 'none';
		}

		captureStep++;
		updateUIForStep();
		validateForm();
	}

	function retakeAll() {
		captureStep = 0;

		// Clear inputs and previews
		[0, 1, 2].forEach(i => {
			inputs[i].value = '';
			previews[i].style.display = 'none';
			previews[i].src = '';
			ticks[i].style.display = 'none';
			// Restore placeholder text
			if (placeholders[i]) {
				placeholders[i].style.display = '';
			}
		});

		startCamera();
		validateForm();
	}

	// Event Listeners
	actionBtn.addEventListener('click', startCamera);
	captureBtn.addEventListener('click', capture);
	retakeBtn.addEventListener('click', retakeAll);

	// Basic client-side validation
	function validateForm() {
		const firstName = document.getElementById('first_name').value.trim();
		const lastName = document.getElementById('last_name').value.trim();
		const email = document.getElementById('email').value.trim();
		const password = document.getElementById('password').value.trim();
		const confirmPassword = document.getElementById('confirm_password').value.trim();
		const pin = document.getElementById('pin').value.trim();

		const allPhotos = inputs[0].value && inputs[1].value && inputs[2].value;
		const passwordsMatch = password === confirmPassword;
		const pinValid = /^\d{4}$/.test(pin);

		signupBtn.disabled = !(firstName && lastName && email && password && confirmPassword && passwordsMatch && allPhotos && pinValid);
	}

	['first_name', 'last_name', 'email', 'password', 'confirm_password', 'pin'].forEach(id => document.getElementById(id).addEventListener('input', validateForm));

	// on submit, disable signup button to prevent double submit
	document.getElementById('adminSignupForm').addEventListener('submit', (e) => {
		signupBtn.disabled = true;
		signupBtn.textContent = 'Creating account...';
	});
</script>
{% endblock %}