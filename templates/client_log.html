{% extends 'base.html' %}
{% block title %}Client Log â€” HR Logbook{% endblock %}

{% block content %}
<style>
	@keyframes scan {
		0% {
			top: 0;
		}

		100% {
			top: 100%;
		}
	}

	.modal,
	.modal-dialog {
		z-index: 9999 !important;
	}

	.modal-backdrop {
		display: none !important;
	}

	.modal-content {
		pointer-events: auto !important;
	}

	.modal-dialog {
		margin-top: 100px;
	}

	.client-log-container {
		display: flex;
		gap: 4px;
		align-items: flex-start;
		justify-content: center;
	}


	.system-log-card {
		width: 320px;
		min-height: 460px;
		max-height: 460px;
		overflow: auto;
		border-radius: 8px;
		border: 4px solid rgba(0, 0, 0, 0.06);
		background: rgba(255, 255, 255, 0.02);
		backdrop-filter: blur(8px);
		-webkit-backdrop-filter: blur(8px);
		padding: 12px;
		color: var(--text-color);
	}

	.match-card {
		width: 320px;
		min-height: 460px;
		max-height: 460px;
		overflow: auto;
		border-radius: 8px;
		border: 4px solid rgba(0, 0, 0, 0.06);
		background: rgba(255, 255, 255, 0.02);
		backdrop-filter: blur(8px);
		-webkit-backdrop-filter: blur(8px);
		padding: 12px;
		color: var(--text-color);
	}

	@media (max-width: 767px) {
		.client-log-container {
			flex-direction: column;
			gap: 16px;
		}

		.camera-card {
			width: 100%;
			height: auto;
			min-height: 300px;
		}

		.system-log-card {
			width: 100%;
			max-height: none;
		}

		.match-card {
			width: 100%;
			max-height: none;
		}
	}



	/* Reduce font size for purpose labels by 1 point */
	#purpose_checkboxes .form-check-label {
		font-size: 15px;
		text-align: left;
	}

	/* Style purpose checkboxes */
	#purpose_checkboxes .form-check {
		margin-bottom: 4px;
		display: block;
	}

	#purpose_checkboxes .form-check:hover,
	#purpose_checkboxes .form-check-input:hover,
	#purpose_checkboxes .form-check-label:hover {
		cursor: pointer;
	}

	#purpose_checkboxes .form-check:last-child {
		margin-bottom: 0;
	}
</style>
<div class="card shadow-lg">
	<div class="card-header d-flex justify-content-between align-items-center">
		<h5 class="mb-0" style="color: var(--text-color);"><i class="fas fa-camera"></i> Client Log (Face Recognition)
		</h5>
		<div class="d-flex gap-2">
			<button type="button" title="Use override if you are not identified correctly!"
				class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#overrideModal">
				<i class="fas fa-edit"></i> Override
			</button>
			<a href="{{ url_for('client.client_log_help') }}" class="btn btn-outline-primary btn-sm"
				title="How to use Client Log">
				<i class="fas fa-question-circle"></i> Help
			</a>
		</div>
	</div>
	<div class="card-body text-center">
		<div class="client-log-container">
			<div class="camera-card shadow-lg rounded">
				<!-- video preview (fills card) -->
				<video id="video" width="420" height="420" autoplay playsinline muted
					style="object-fit:cover; width:420px; height:420px; border-radius:6px; display:none;"></video>

				<!-- face position guide (subtle broken square corners) -->
				<div id="face-guide" aria-hidden="true">
					<div class="fg-corner top-left"></div>
					<div class="fg-corner top-right"></div>
					<div class="fg-corner bottom-right"></div>
					<div class="fg-corner bottom-left"></div>
				</div>

				<!-- placeholder when camera not active -->
				<div id="camera-placeholder" class="text-center text-muted" style="color:#9aa6bc">
					<div style="font-size:44px; opacity:0.5">ðŸ“·</div>
					<div style="margin-top:8px;">Camera Preview</div>
					<!--<h5 class="mt-3" style="color:#9aa6bc; font-weight:600;">Client Log (Face Recognition)</h5>
					<p class="text-muted small" style="color:#9aa6bc;">Capture Client photo and record entry/exit-->

				</div>

				<!-- captured preview overlay (inside camera container so absolute sizing is constrained) -->
				<canvas id="canvas" width="420" height="420"
					style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; border-radius:6px;"></canvas>
				<img id="preview" src="" alt="Preview"
					style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; object-fit:contain; border-radius:6px; background:#0f1720;" />
				<div id="scan-line"
					style="display:none; position:absolute; top:0; left:0; width:100%; height:2px; background:linear-gradient(90deg, transparent, rgba(0,255,0,0.8), transparent); z-index:20; animation: scan 2s linear;">
				</div>
				<!-- camera error overlay (shown inside camera container at top) -->
				<div id="camera-error"
					style="display:none; position:absolute; top:10px; left:50%; transform:translateX(-50%); z-index:25; background:rgba(0,0,0,0.6); color:#fff; padding:6px 10px; border-radius:6px; font-weight:600; font-size:0.95rem;">
					No face detected
				</div>
				<!-- camera action button placed inside the camera container -->
				<button id="camera-action" title="Start or control the camera for face recognition" class="btn btn-lg"
					style="position:absolute; bottom:12px; left:50%; transform:translateX(-50%); z-index:10; min-width:140px; background:rgba(0,0,0,0.7); color:white; border:none; border-radius:6px; padding:8px 16px;">Start
					Camera</button>
			</div>


			<!-- System log card -->
			<div class="system-log-card">
				<h6 class="mb-2">Active Clients</h6>
				<div id="systemLog" style="font-size:0.9rem; line-height:1.25;">Loading...</div>
			</div>
		</div>

		<!-- Match Modal -->
		<div class="modal fade" id="matchModal" tabindex="-1" aria-labelledby="matchModalLabel" aria-hidden="true"
			data-bs-backdrop="static" data-bs-keyboard="false">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="matchModalLabel">Match Found</h5>
					</div>
					<div class="modal-body">
						<div class="text-center mb-3">
							<!-- Display photo if available, or icon -->
							<img id="match_photo_preview" src="" alt="Client Photo"
								style="max-width: 150px; border-radius: 8px; display: none;" class="mb-2 mx-auto">
							<div id="match_photo_placeholder" style="font-size: 64px; color: #ccc;" class="mb-2">
								<i class="fas fa-user-circle"></i>
							</div>
							<h4 id="match_name_modal" class="fw-bold"></h4>
							<p class="text-muted">
								<span id="match_gender_modal"></span>
								<span id="match_age_modal"></span>
							</p>
						</div>
					</div>
					<div class="modal-footer justify-content-center">
						<button id="btn_not_me" type="button" class="btn btn-danger me-2">That's not me, Scan
							again</button>
						<button id="btn_thats_me" type="button" class="btn btn-success">That's me</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Purpose Modal -->
		<div class="modal fade" id="purposeModal" tabindex="-1" aria-labelledby="purposeModalLabel" aria-hidden="true"
			data-bs-backdrop="static" data-bs-keyboard="false">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="purposeModalLabel">Select Purpose</h5>
					</div>
					<div class="modal-body text-start">
						<label class="form-label mb-3"><i class="fas fa-question-circle"></i> What is your
							purpose?</label>
						<div id="purpose_checkboxes">
							<div class="form-check">
								<input class="form-check-input" type="checkbox" value="RECEIVE DOCUMENT/S REQUESTED"
									id="purpose_1">
								<label class="form-check-label" for="purpose_1">RECEIVE DOCUMENT/S REQUESTED</label>
							</div>
							<div class="form-check">
								<input class="form-check-input" type="checkbox" value="SUBMIT DOCUMENT/S"
									id="purpose_2">
								<label class="form-check-label" for="purpose_2">SUBMIT DOCUMENT/S</label>
							</div>
							<div class="form-check">
								<input class="form-check-input" type="checkbox" value="REQUEST FORM/S" id="purpose_3">
								<label class="form-check-label" for="purpose_3">REQUEST FORM/S</label>
							</div>
							<div class="form-check">
								<input class="form-check-input" type="checkbox" value="PROCESS APPOINTMENT"
									id="purpose_4">
								<label class="form-check-label" for="purpose_4">PROCESS APPOINTMENT</label>
							</div>
							<div class="form-check">
								<input class="form-check-input" type="checkbox" value="INQUIRE" id="purpose_5">
								<label class="form-check-label" for="purpose_5">INQUIRE</label>
							</div>
							<div class="form-check">
								<input class="form-check-input" type="checkbox" value="OTHERS" id="purpose_6">
								<label class="form-check-label" for="purpose_6">OTHERS</label>
							</div>
						</div>
						<p id="purpose_error" class="text-danger mt-2" style="display:none;">Please select at least one
							purpose.
						</p>
					</div>
					<div class="modal-footer">
						<button id="btn_purpose_next" type="button" class="btn btn-outline-primary">Next</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Additional Info Modal -->
		<div class="modal fade" id="additionalInfoModal" tabindex="-1" aria-labelledby="additionalInfoModalLabel"
			aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="additionalInfoModalLabel">Additional Information</h5>
					</div>
					<div class="modal-body text-start">
						<label for="additional_info" title="Specific purpose and/or for whom." class="form-label"><i
								class="fas fa-info-circle"></i> Please specify details</label>
						<input type="text" title="Specific purpose and/or for whom." id="additional_info"
							placeholder="E.g. DTR of Mr. Dela Cruz" class="form-control">
						<p id="info_error" class="text-danger mt-2" style="display:none;">Please provide additional
							information.
						</p>
					</div>
					<div class="modal-footer">
						<button id="btn_time_in" type="button" class="btn btn-success"><i
								class="fas fa-sign-in-alt"></i> Time
							In</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Override Modal -->
		<div class="modal fade" id="overrideModal" tabindex="-1" aria-labelledby="overrideModalLabel" aria-hidden="true"
			data-bs-backdrop="false">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="overrideModalLabel">Manual Override</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<label for="manual_search" class="form-label mb-1">Search by name or ID (manual
							override)</label>
						<div class="input-group">
							<input type="text" id="manual_search" title="Search for a client by name or client ID"
								class="form-control" placeholder="Type name or ID..." aria-label="Search client"
								autofocus>
							<button id="use_typed" title="Use the entered text as the client identifier"
								class="btn btn-outline-primary" type="button" data-bs-dismiss="modal">Use</button>
						</div>
						<div id="search_suggestions" class="list-group mt-2"
							style="max-height:160px; overflow:auto; display:none;"></div>
						<div class="form-text mt-1">If the camera identifies the wrong person, search and select the
							correct client or press <strong>Use</strong> to accept the typed ID.</div>
					</div>
				</div>
			</div>
		</div>

	</div>
</div>
{% endblock %}

{% block scripts %}
<script>
	const video = document.getElementById('video');
	const canvas = document.getElementById('canvas');
	const preview = document.getElementById('preview');
	const scanLine = document.getElementById('scan-line');
	const placeholder = document.getElementById('camera-placeholder');
	const actionBtn = document.getElementById('camera-action');
	const cameraCard = document.querySelector('.camera-card');
	// Removed resultDiv and card elements
	const purposeCheckboxes = document.querySelectorAll('#purpose_checkboxes input[type="checkbox"]');
	const additionalInfoInput = document.getElementById('additional_info');
	// New modal elements
	const matchModalEl = document.getElementById('matchModal');
	const matchModal = new bootstrap.Modal(matchModalEl);
	const matchNameModal = document.getElementById('match_name_modal');
	const matchGenderModal = document.getElementById('match_gender_modal');
	const matchAgeModal = document.getElementById('match_age_modal');
	const matchPhotoPreview = document.getElementById('match_photo_preview');
	const matchPhotoPlaceholder = document.getElementById('match_photo_placeholder');

	const purposeModalEl = document.getElementById('purposeModal');
	const purposeModal = new bootstrap.Modal(purposeModalEl);
	const purposeError = document.getElementById('purpose_error');

	const additionalInfoModalEl = document.getElementById('additionalInfoModal');
	const additionalInfoModal = new bootstrap.Modal(additionalInfoModalEl);
	const infoError = document.getElementById('info_error');

	const btnThatsMe = document.getElementById('btn_thats_me');
	const btnNotMe = document.getElementById('btn_not_me');
	const btnPurposeNext = document.getElementById('btn_purpose_next');
	const btnTimeIn = document.getElementById('btn_time_in');

	const cameraError = document.getElementById('camera-error');

	function setError(msg) {
		const m = String(msg || '');
		if (cameraError) {
			const lowerMsg = m.toLowerCase();
			// Display if contains specific keywords OR show all errors if user meant all "system messages"
			// Given the user's specific request for "No matching client found", we ensure it's included.
			if (m && (lowerMsg.includes('no face') || lowerMsg.includes('detect') || lowerMsg.includes('no matching client found') || lowerMsg.includes('error') || lowerMsg.includes('fail'))) {
				cameraError.textContent = m;
				cameraError.style.display = 'block';
			} else {
				cameraError.style.display = 'none';
			}
		}
	}

	// Manual search elements
	const manualSearch = document.getElementById('manual_search');
	const suggestionsBox = document.getElementById('search_suggestions');
	const useTypedBtn = document.getElementById('use_typed');

	// Debounce helper
	function debounce(fn, wait) {
		let t = null;
		return function (...args) {
			clearTimeout(t);
			t = setTimeout(() => fn.apply(this, args), wait);
		};
	}

	// Sound functions
	function playSuccessSound() {
		try {
			const audioContext = new (window.AudioContext || window.webkitAudioContext)();
			const oscillator = audioContext.createOscillator();
			const gainNode = audioContext.createGain();
			oscillator.connect(gainNode);
			gainNode.connect(audioContext.destination);
			oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
			gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
			gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
			oscillator.start(audioContext.currentTime);
			oscillator.stop(audioContext.currentTime + 0.2);
		} catch (e) { console.warn('Success sound failed:', e); }
	}

	function playErrorSound() {
		try {
			const audioContext = new (window.AudioContext || window.webkitAudioContext)();
			const oscillator = audioContext.createOscillator();
			const gainNode = audioContext.createGain();
			oscillator.connect(gainNode);
			gainNode.connect(audioContext.destination);
			oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
			gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
			gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
			oscillator.start(audioContext.currentTime);
			oscillator.stop(audioContext.currentTime + 0.5);
		} catch (e) { console.warn('Error sound failed:', e); }
	}

	async function performSearch(q) {
		if (!q || q.length < 1) { suggestionsBox.style.display = 'none'; suggestionsBox.innerHTML = ''; return; }
		try {
			const res = await fetch('/search_client?q=' + encodeURIComponent(q));
			const data = await res.json();
			if (!Array.isArray(data) || data.length === 0) {
				suggestionsBox.style.display = 'none';
				suggestionsBox.innerHTML = '';
				return;
			}
			suggestionsBox.innerHTML = '';
			data.forEach(item => {
				const el = document.createElement('button');
				el.type = 'button';
				el.className = 'list-group-item list-group-item-action';
				el.textContent = (item.full_name ? item.full_name + ' â€” ' : '') + item.client_id;
				el.dataset.clientId = item.client_id;
				el.dataset.fullName = item.full_name || '';
				el.dataset.gender = item.gender || '';
				el.dataset.age = item.age || '';
				// photo url if available? item.photo_url could be added to backend search
				el.setAttribute('data-bs-dismiss', 'modal');
				el.addEventListener('click', () => {
					// pick this suggestion
					handleMatchFound({
						client_id: el.dataset.clientId,
						full_name: el.dataset.fullName,
						gender: el.dataset.gender,
						age: el.dataset.age
					});
					suggestionsBox.style.display = 'none';
				});
				suggestionsBox.appendChild(el);
			});
			suggestionsBox.style.display = 'block';
		} catch (err) {
			console.error('Search failed', err);
			suggestionsBox.style.display = 'none';
		}
	}

	const debouncedSearch = debounce((e) => performSearch(e.target.value.trim()), 250);

	if (manualSearch) {
		manualSearch.addEventListener('input', debouncedSearch);
		manualSearch.addEventListener('keydown', (e) => {
			if (e.key === 'Enter') {
				e.preventDefault();
				const first = suggestionsBox.querySelector('button');
				if (first) { first.click(); }
				else { useTyped(); }
			}
		});
	}

	function useTyped() {
		const v = manualSearch && manualSearch.value && manualSearch.value.trim();
		if (!v) {
			setError('Please type an ID or name before using.');
			return;
		}
		// use the typed value
		handleMatchFound({
			client_id: v,
			full_name: v,
			gender: '',
			age: ''
		});
		suggestionsBox.style.display = 'none';
		// Close the override modal
		const modal = document.getElementById('overrideModal');
		const bsModal = bootstrap.Modal.getInstance(modal);
		if (bsModal) bsModal.hide();
	}

	if (useTypedBtn) useTypedBtn.addEventListener('click', useTyped);

	function stopCamera() {
		if (stream) {
			stream.getTracks().forEach(t => t.stop());
			stream = null;
		}
		video.srcObject = null;
		video.style.display = 'none';
		placeholder.style.display = 'block';
		preview.style.display = 'none';
		canvas.style.display = 'none';
		cameraState = 'stopped';
		actionBtn.textContent = 'Start Camera';
		capturedPhotoData = null;
	}

	let stream = null;
	let currentClientId = null;
	let cameraState = 'stopped';
	let lastPurpose = null;
	let capturedPhotoData = null;

	// Handle a successful match (from camera or manual override)
	function handleMatchFound(clientData) {
		currentClientId = clientData.client_id;
		matchNameModal.textContent = clientData.full_name || '(no name)';

		const gender = clientData.gender ? ('â€¢ ' + clientData.gender) : '';
		const age = clientData.age ? ('â€¢ ' + clientData.age) : '';
		matchGenderModal.textContent = gender;
		matchAgeModal.textContent = age;

		// If we wanted to show a photo, we'd set it here. For now show placeholder or captured logic
		// matchPhotoPreview.src = ... 
		matchPhotoPreview.style.display = 'none';
		matchPhotoPlaceholder.style.display = 'block';

		playSuccessSound();
		matchModal.show();
	}

	// Modal Button Handlers

	// 1. That's me
	btnThatsMe.addEventListener('click', () => {
		matchModal.hide();
		// Clear previous selections
		purposeCheckboxes.forEach(cb => cb.checked = false);
		purposeError.style.display = 'none';
		purposeModal.show();
	});

	// 2. That's not me. Scan again
	btnNotMe.addEventListener('click', () => {
		matchModal.hide();
		currentClientId = null;
		// If camera was stopped (e.g. from manual override), maybe we shouldn't auto start?
		// But if it was from scan, we want to scan again.
		// Let's assume user wants to retry scanning.
		if (cameraState === 'stopped') {
			cameraAction(); // Start camera
		} else if (cameraState === 'captured') {
			// retry capture immediately? or just let them click scan?
			// Resetting to 'started' state to allow re-scan
			preview.style.display = 'none';
			video.style.display = 'block';
			scanLine.style.display = 'none';
			cameraState = 'started';
			actionBtn.textContent = 'SCAN';
		}
	});

	// 3. Purpose Next
	btnPurposeNext.addEventListener('click', () => {
		// Validate purpose
		let selected = false;
		purposeCheckboxes.forEach(cb => { if (cb.checked) selected = true; });
		if (!selected) {
			purposeError.style.display = 'block';
			return;
		}
		purposeError.style.display = 'none';
		purposeModal.hide();

		// Reset info input
		additionalInfoInput.value = '';
		infoError.style.display = 'none';
		additionalInfoModal.show();
	});

	// 4. Time In
	btnTimeIn.addEventListener('click', () => {
		const info = additionalInfoInput.value.trim();
		if (!info) {
			infoError.style.display = 'block';
			return;
		}
		infoError.style.display = 'none';
		// Send Log
		sendLog('time_in');
		additionalInfoModal.hide();
	});


	async function cameraAction() {
		setError('');
		if (cameraState === 'stopped') {
			try {
				stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
				video.srcObject = stream;
				await video.play();
				video.style.display = 'block';
				placeholder.style.display = 'none';
				cameraState = 'started';
				actionBtn.textContent = 'SCAN';
				setError('');
			} catch (err) {
				console.error('Camera error:', err);
				setError('Could not start camera: ' + err.message);
			}
			return;
		}

		if (cameraState === 'started') {
			if (!stream) { setError('Start the camera first'); return; }
			const ctx = canvas.getContext('2d');
			const containerW = 420;
			const containerH = 420;
			const vw = video.videoWidth || 420;
			const vh = video.videoHeight || 420;
			const scale = Math.max(containerW / vw, containerH / vh);
			const scaledW = vw * scale;
			const scaledH = vh * scale;
			let sourceX = 0, sourceY = 0, sourceW = vw, sourceH = vh;
			if (scaledW > containerW) {
				const cropAmount = (scaledW - containerW) / scale;
				sourceX = cropAmount / 2;
				sourceW = vw - cropAmount;
			} else {
				const cropAmount = (scaledH - containerH) / scale;
				sourceY = cropAmount / 2;
				sourceH = vh - cropAmount;
			}
			let targetW = sourceW;
			let targetH = sourceH;
			const MAX_W = 800;
			if (targetW > MAX_W) {
				const scaleDown = MAX_W / targetW;
				targetW = Math.round(targetW * scaleDown);
				targetH = Math.round(targetH * scaleDown);
			}
			canvas.width = targetW;
			canvas.height = targetH;
			ctx.drawImage(video, sourceX, sourceY, sourceW, sourceH, 0, 0, targetW, targetH);
			const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
			preview.src = dataUrl;
			preview.style.display = 'block';
			scanLine.style.display = 'block';
			scanLine.style.animation = 'none';
			setTimeout(() => { scanLine.style.animation = 'scan 2s linear'; }, 10);
			canvas.style.display = 'none';
			video.style.display = 'none';
			preview.style.objectFit = 'contain';
			cameraState = 'captured';
			actionBtn.textContent = 'Stop Camera';
			capturedPhotoData = dataUrl;

			const fd = new FormData();
			fd.append('photo_data', dataUrl);
			try {
				const res = await fetch('/identify', { method: 'POST', body: fd });
				const body = await res.json();
				if (body.ok) {
					// Success - Show Match Modal
					handleMatchFound({
						client_id: body.client_id,
						full_name: body.full_name,
						gender: body.gender,
						age: body.age
					});
				} else {
					playErrorSound();
					setError(body.error || 'No match found');
					// allow retry
					setTimeout(() => {
						// Optional: auto reset or just let them click Stop/Start?
						// Let's just update UI to show error and let user decide
					}, 2000);
				}
			} catch (err) {
				setError('Identification failed: ' + err.message);
			}
			return;
		}

		if (cameraState === 'captured') {
			captureReset();
			return;
		}
	}

	function captureReset() {
		if (stream) {
			stream.getTracks().forEach(t => t.stop());
			stream = null;
		}
		video.srcObject = null;
		video.style.display = 'none';
		placeholder.style.display = 'block';
		preview.style.display = 'none';
		canvas.style.display = 'none';
		cameraState = 'stopped';
		actionBtn.textContent = 'Start Camera';
	}

	actionBtn.addEventListener('click', cameraAction);
	if (cameraCard) {
		cameraCard.addEventListener('click', (e) => {
			if (e.target === actionBtn) return;
			cameraAction();
		});
	}

	async function sendLog(action) {
		if (!currentClientId) { setError('No identified client'); playErrorSound(); return; }

		let purposes = [];
		if (action === 'time_in') {
			purposeCheckboxes.forEach(cb => {
				if (cb.checked) purposes.push(cb.value);
			});
		}

		try {
			const res = await fetch('/log_action', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({
					client_id: currentClientId,
					action,
					purposes,
					additional_info: additionalInfoInput.value || null,
					photo_data: capturedPhotoData
				})
			});
			const body = await res.json();
			if (body.ok) {
				playSuccessSound();
				setError('');
				// Refresh logs
				if (typeof refreshTodayLogs === 'function') {
					try { refreshTodayLogs(); } catch (e) { console.warn('refreshTodayLogs failed', e); }
				}
				// Cleanup
				currentClientId = null;
				captureReset();

				// Show a brief success toast or message on page?
				// existing implementation just showed it in the list
			} else {
				playErrorSound();
				setError(body.error || 'Failed to record log');
			}
		} catch (err) {
			playErrorSound();
			setError('Logging failed: ' + err.message);
		}
	}

	// Fetch and show system logs (only logged-in clients) in the right-side div
	async function refreshTodayLogs() {
		const el = document.getElementById('systemLog');
		if (!el) return;
		try {
			const res = await fetch('/today_logs');
			const data = await res.json();
			if (!Array.isArray(data)) {
				el.innerHTML = '<div class="text-muted">Error loading logs</div>';
				return;
			}
			if (data.length === 0) {
				el.innerHTML = '<div class="text-muted">No active clients.</div>';
				return;
			}
			el.innerHTML = '';
			data.forEach(r => {
				const item = document.createElement('div');
				item.className = 'd-flex justify-content-between align-items-center mb-2 p-2 border rounded';

				const name = r.full_name || r.client_id;
				const timeIn = r.time_in ? new Date(r.time_in).toLocaleTimeString() : 'Unknown';
				const purpose = r.purpose || '';
				item.innerHTML = `
				<div class="d-flex flex-column align-items-start" style="text-align: left;">
					<strong>${name}</strong>
					<small class="text-muted" style="text-align: left;"><span class="text-success">In: ${timeIn}</span> | <span class="text-primary">${purpose}</span></small>
				</div>
				<button class="btn btn-sm btn-outline-danger" title="Logout this client" onclick="logoutClient('${r.client_id}')">Logout</button>
			`;
				el.appendChild(item);
			});
		} catch (err) {
			el.innerHTML = '<div class="text-danger">Failed to load logs: ' + err.message + '</div>';
		}
	}

	async function logoutClient(clientId) {
		try {
			const res = await fetch('/logout_client/' + encodeURIComponent(clientId), { method: 'POST' });
			const body = await res.json();
			if (body.ok) { refreshTodayLogs(); }
			else { alert('Failed to logout client: ' + (body.error || 'Unknown error')); }
		} catch (err) { alert('Logout failed: ' + err.message); }
	}

	refreshTodayLogs();
	setInterval(refreshTodayLogs, 10000);

	document.getElementById('overrideModal').addEventListener('shown.bs.modal', function () {
		document.getElementById('manual_search').focus();
	});
</script>
{% endblock %}